<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>泰拉瑞亚EasyBuildMod便捷建造模组开发 | lxmghct's blog</title>
  <meta name="description"
    content="github地址：https://github.com/lxmghct/Terraria-EasyBuildMod如果觉得有帮助，记得在github上点个star哦~">


  <link rel="stylesheet" href=" /assets/css/bootstrap.css">
  <link rel="stylesheet" href=" /assets/css/font-awesome.css">
  <link rel="stylesheet" href=" /assets/css/main.css">
  <link rel="stylesheet" href=" /assets/css/layouts/default.css">
  <link rel="stylesheet" href=" /assets/css/highlight/default.min.css">
  <link rel="stylesheet" href=" /assets/css/includes/header.css">
  <link rel="stylesheet" href=" /assets/css/includes/footer.css">
  <link rel="stylesheet" href=" /assets/css/includes/search.css">
  <link rel="stylesheet" href=" /assets/css/includes/pagination.css">
  <link rel="stylesheet" href=" /assets/css/layouts/post.css">
  <link rel="stylesheet" href=" /assets/css/highlight/post-highlight.css">
  <link rel="stylesheet" href=" /assets/css/pages/index.css">
  <link rel="shortcut icon" href="" />
  <link rel="canonical" href="/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/2023/03/25/%E6%B3%B0%E6%8B%89%E7%91%9E%E4%BA%9AEasyBuildMod%E4%BE%BF%E6%8D%B7%E5%BB%BA%E9%80%A0%E6%A8%A1%E7%BB%84%E5%BC%80%E5%8F%91.html">
  <link rel="alternate" type="application/rss+xml" title="lxmghct's blog" href=" /feed.xml" />
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>


<body>

  <div class="site-header">
	<div class="container">
		<div class="row">
			<div class="navbar navbar-default" role="navigation">

				<div class="navbar-header col-xs-8 col-sm-8 col-md-3 col-lg-3 center">
					<div class="header-title">
						<a href="/" title="首页"></a>
						<i class="fa fa-home fa-2x"></i>
						<a class="site-title" href="/">lxmghct's blog</a>
					</div>
				</div>

				<div class="col-md-6 col-lg-6 hidden-sm hidden-xs center">
					<div class="site-nav">
						<ul class="nav nav-pills">
							<li class="select"><a class="page-link" href="/pages/classify.html">分类</a></li>
							<li class="select"><a class="page-link" href="/pages/archive.html">归档</a></li>
							<li class="select"><a class="page-link" href="/pages/tags.html">标签</a></li>
							<li class="select"><a class="page-link" href="/pages/about.html">关于</a></li>
						</ul>
					</div>
				</div>

				<div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
					<div id="header-search" class="search-input-container">
						<input id="header-search-input" type="text" class="header-search-input" placeholder="Search">
						<!--搜索图标-->
						<i class="fa fa-search fa-lg search-icon"></i>
					</div>
				</div>

				<!-- 宽度不够时显示 -->
				<div class="hidden-lg hidden-md col-sm-4 col-xs-4">
					<div class="header-hidden-buttons">
						<i class="fa fa-search fa-lg search-icon"></i>
						<i class="fa fa-bars fa-2x menu-icon"></i>
						<!-- 用于控制菜单的显示和隐藏 -->
						<input type="checkbox" id="nav-trigger" class="nav-trigger">
					</div>
				</div>

				<div class="phone-nav">
					<ul>
						<li><a href="/">首 页</a></li>
						<li><a href="/pages/classify.html">分 类</a></li>
						<li><a href="/pages/archive.html">归 档</a></li>
						<li><a href="/pages/tags.html">标 签</a></li>
						<li><a href="/pages/about.html">关 于</a></li>
					</ul>
				</div>

			</div>
		</div>
	</div>
</div>

<!--遮罩层-->
<div class="search-mask"></div>
<div class="search-container">
  <!-- 右上角关闭按钮 -->
  <i class="fa fa-times fa-2x search-container-close"></i>
  <div class="search-container-main">
    <div class="search-container-wrapper">
      <div class="search-input-container">
        <input type="text" class="search-input" placeholder="Search">
        <!--搜索图标-->
        <i class="fa fa-search fa-lg search-icon search-start"></i>
        <!--关闭图标-->
        <i class="fa fa-times fa-lg search-icon search-clear"></i>
      </div>
      <div class="search-filter">
        <!--只查找标题选择框-->
        <input type="checkbox" class="search-filter-input">
        <span class="search-filter-text">只查找标题</span>
      </div>
      <div class="search-result-summary"></div>
      <div class="search-result-container">
      </div>
      <div class="search-pagination">
        <!-- pagination.html -->

<div class="my-pagination">
  <ul class="my-pager">
    <li class="active">1</li>
    <li>2</li>
  </ul>
  <span class="my-pagination__sizes">
    <span class="my-pagination__sizes__label">每页</span>
    <select class="my-pagination__sizes__select" autocomplete="off">
      <option>5</option>
      <option>10</option>
      <option>20</option>
    </select>
    <span class="my-pagination__sizes__label">条</span>
  </span>
  <span class="my-pagination__total">共 0 条</span>
  <span class="my-pagination__goto">
    <span class="my-pagination__goto__label">前往</span>
    <input class="my-pagination__goto__input" type="text" />
    <span class="my-pagination__goto__label">页</span>
  </span>
</div>

<script>
  (function () {
    const contentSelector = '.search-result-container';
    const parentSelector = '.search-pagination';
    const contentContainer = document.querySelector(`${contentSelector}`);
    if (!contentContainer || !contentSelector || !parentSelector) {
      console.error("pagination.html: content or parent is not defined");
      return;
    }
    const pageItems = []
    const pagerContainer = document.querySelector(`${parentSelector} .my-pager`);
    const totalContainer = document.querySelector(`${parentSelector} .my-pagination__total`);
    const sizesSelect = document.querySelector(`${parentSelector} .my-pagination__sizes__select`);
    const gotoInput = document.querySelector(`${parentSelector} .my-pagination__goto__input`);

    const paginationData = {
      total: 0,
      pageSize: 10,
      currentPage: 1
    }
    sizesSelect.value = paginationData.pageSize;

    function showPagerList() {
      const totalPage = Math.ceil(paginationData.total / paginationData.pageSize);
      pagerContainer.innerHTML = "";
      const createLi = (i) => {
        const li = document.createElement("li");
        li.innerText = i;
        pagerContainer.appendChild(li);
        // add click event
        if (i !== "...") {
          li.addEventListener("click", () => {
            paginationData.currentPage = i;
            changePage();
          });
        }
        // set active
        if (i === paginationData.currentPage) {
          li.classList.add("active");
        }
      }
      const start = 1, end = totalPage;
      const pagerNumberList = [];
      if (paginationData.currentPage - start > 3) {
        pagerNumberList.push(...[start, start + 1, "...", paginationData.currentPage - 1, paginationData.currentPage]);
      } else {
        for (let i = start; i <= paginationData.currentPage; i++) {
          pagerNumberList.push(i);
        }
      }
      if (end - paginationData.currentPage > 3) {
        pagerNumberList.push(...[paginationData.currentPage + 1, "...", end - 1, end]);
      } else {
        for (let i = paginationData.currentPage + 1; i <= end; i++) {
          pagerNumberList.push(i);
        }
      }
      pagerNumberList.forEach((item) => {
        createLi(item);
      });
    }

    function changeTotal() {
      pageItems.length = 0;
      for (let i = 0; i < contentContainer.children.length; i++) {
        if (contentContainer.children[i].classList.contains("my-pagination") || contentContainer.children[i].tagName === "SCRIPT") {
          continue;
        }
        pageItems.push(contentContainer.children[i]);
      }
      paginationData.total = pageItems.length;
      totalContainer.innerText = `共 ${paginationData.total} 条`;
    }

    function changeContentShow() {
      const showPageStart = paginationData.pageSize * (paginationData.currentPage - 1);
      const showPageEnd = paginationData.pageSize * paginationData.currentPage;
      for (let i = 0; i < paginationData.total; i++) {
        if (i >= showPageStart && i < showPageEnd) {
          pageItems[i].classList.remove("hide");
        } else {
          pageItems[i].classList.add("hide");
        }
      }
    }

    function changePage() {
      showPagerList();
      changeContentShow();
      gotoInput.value = paginationData.currentPage;
    }

    function startPagination() {
      changeTotal();
      changePage();
    }

    sizesSelect.addEventListener("change", (e) => {
      paginationData.pageSize = e.target.value;
      paginationData.currentPage = 1;
      changePage();
    });

    gotoInput.addEventListener("keyup", (e) => {
      if (e.keyCode === 13) {
        const gotoPage = parseInt(e.target.value);
        if (gotoPage > 0 && gotoPage <= Math.ceil(paginationData.total / paginationData.pageSize)) {
          paginationData.currentPage = gotoPage;
          changePage();
        }
      }
    });

    // 监听内容变化
    const observer = new MutationObserver((mutationsList) => {
      for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
          changeTotal();
          paginationData.currentPage = 1;
          changePage();
        }
      }
    });
    observer.observe(contentContainer, { childList: true });

    startPagination();
  })();
</script>
      </div>
    </div>
  </div>
</div>


  <div class="content">
    <div class="container">
      <div class="row main-container">

        
          <div class="col-md-2 col-lg-2 hidden-xs hidden-sm left-side fadein-left">
            
<div class="toc-container">
  <div class="toc-header">
    <h3>目录导航</h3>
  </div>
  <ul id="toc-list"></ul>
</div>

          </div>
          <div class="my-col col-xs-12 col-sm-12 col-md-8 col-lg-8 fadein-right">
            <div class="page-content box-shadow"><div class="post">

  <header class="post-header">
    <h1 class="post-title">泰拉瑞亚EasyBuildMod便捷建造模组开发</h1>
    <div class="info">
      <p class="post-meta">
        <i class="fa fa-calendar"></i>
        &nbsp;
        2023-03-25 08:10
        
        
      </p>
      
      <span class="post-classify-list">
        <i class="fa fa-folder-open"></i>
        
        <a class="category" data-tag="开发日志">开发日志</a>
        
      </span>
      &nbsp;
      
      
      <span class="post-tag-list">
        <i class="fa fa-tags"></i>
        <span class="index-post-tag">
          
          <a data-tag="C#">C#</a>
          
          <a data-tag="游戏">游戏</a>
          
          <a data-tag="terraria">terraria</a>
          
        </span>
      </span>
      
    </div>
  </header>

  <article class="post-content">
    <style>
    img {
        margin: 3px auto;
    }
</style>

<p><strong>github地址：</strong>
<a href="https://github.com/lxmghct/Terraria-EasyBuildMod">https://github.com/lxmghct/Terraria-EasyBuildMod</a>
如果觉得有帮助，记得在github上点个star哦~</p>

<p>本文首次发布于博客园：<a href="https://www.cnblogs.com/lxm-cnblog/p/17255401.html">https://www.cnblogs.com/lxm-cnblog/p/17255401.html</a>
现在转移到 github pages 上。</p>

<p><strong>创意工坊搜索EasyBuildMod即可找到模组</strong></p>
<h2 id="目录">目录</h2>
<ul>
  <li><a href="#1简介">简介</a></li>
  <li><a href="#2模组物品制作">模组物品制作</a>
    <ul>
      <li><a href="#21物品拾取磁铁">物品拾取磁铁</a></li>
      <li><a href="#22物块放置与摧毁助手基类">物块放置与摧毁助手基类</a>
        <ul>
          <li><a href="#221item实现">Item实现</a></li>
          <li><a href="#222菜单实现">菜单实现</a></li>
          <li><a href="#223物块选择框实现">物块选择框实现</a></li>
        </ul>
      </li>
      <li><a href="#23物块放置助手">物块放置助手</a></li>
      <li><a href="#24物块摧毁助手">物块摧毁助手</a></li>
    </ul>
  </li>
  <li><a href="#3多人模式下的相关修改">多人模式下的相关修改</a></li>
  <li><a href="#4开发过程中的其他问题">开发过程中的其他问题</a></li>
</ul>

<h2 id="1简介">1.简介</h2>
<p>EasyBuildMod是一个便捷建造模组，它包含了三个物品：物块放置助手可以快速将物块或墙壁放置在一个矩形区域、物块摧毁助手可以快速摧毁矩形区域内的物块或墙壁、物品拾取磁铁则可用于快速拾取摧毁后掉落的物品。
制作这个模组主要是因为自己在游戏中想挖空或建造地形进行建造战斗场地时，直接手动挖空或放置非常耗时，而自己尝试过某些模组但都不太能满足自己需要，比如Fargo的“城市克星”，摧毁范围大但是墙壁无法破坏，还有“更好的体验”模组，放置和摧毁物块的效率并不算太高。暂时也没找到其他模组（如果有欢迎提出）。所以就自己动手写了一个。</p>

<h2 id="2模组物品制作">2.模组物品制作</h2>
<p>本模组包含三个物品，物品拾取磁铁、物块放置助手和物块摧毁助手。定义了一个全局的<code class="language-plaintext highlighter-rouge">EasyBuildModPlayer</code>类继承自<code class="language-plaintext highlighter-rouge">ModPlayer</code>，来控制使用某些物品或拥有某些效果时玩家的行为改变。</p>

<h3 id="21物品拾取磁铁">2.1物品拾取磁铁</h3>
<p>ItemGrabMagnet，该物品借鉴了懒人模组中的战利品磁铁和ItemMagnetPlus模组。希望达到的效果是使用后玩家拥有“物品拾取”的Buff，可以扩大拾取范围，再次使用则可以关闭。
首先是ItemGrabMagnet的代码。这部分的代码比较简单，就是在玩家使用物品时判断是否已经拥有Buff，如果没有则添加Buff，如果有则移除Buff。
有几个细节的地方：由于想要的是使用磁铁后buff时间无限长，在Buff中设置剩余时间不可见，在给Buff时设置足够长的时间即可。
还有一个要注意的地方就是<code class="language-plaintext highlighter-rouge">CombatText.NewText</code>会默认对所有玩家触发，也就是玩家A在使用时，玩家B也能看到<code class="language-plaintext highlighter-rouge">CombatText.NewText</code>的讯息，所以<code class="language-plaintext highlighter-rouge">CombatText.NewText</code>的第一个参数不能用Main.LocalPlayer，否则其他人使用时也会显示在自己这里。</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ItemGrabBuff</span> <span class="p">:</span> <span class="n">ModBuff</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">SetStaticDefaults</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Main</span><span class="p">.</span><span class="n">buffNoTimeDisplay</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">Main</span><span class="p">.</span><span class="n">debuff</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">buffIndex</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">player</span><span class="p">.</span><span class="n">GetModPlayer</span><span class="p">&lt;</span><span class="n">EasyBuildModPlayer</span><span class="p">&gt;().</span><span class="n">ItemGrabBuff</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">ItemGrabMagnet</span> <span class="p">:</span> <span class="n">ModItem</span>
    <span class="p">{</span>
        <span class="k">internal</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetText</span><span class="p">(</span><span class="kt">string</span> <span class="n">str</span><span class="p">,</span> <span class="k">params</span> <span class="kt">object</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">Language</span><span class="p">.</span><span class="nf">GetTextValue</span><span class="p">(</span><span class="s">$"Mods.EasyBuildMod.Content.Items.ItemGrabMagnet.</span><span class="p">{</span><span class="n">str</span><span class="p">}</span><span class="s">"</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="kt">string</span> <span class="n">Texture</span> <span class="p">=&gt;</span> <span class="s">"EasyBuildMod/Content/Items/ItemGrabMagnet"</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsMagnetOn</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">SetStaticDefaults</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">CreativeItemSacrificesCatalog</span><span class="p">.</span><span class="n">Instance</span><span class="p">.</span><span class="n">SacrificeCountNeededByItemId</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">SetDefaults</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">width</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">height</span> <span class="p">=</span> <span class="m">30</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">maxStack</span> <span class="p">=</span> <span class="m">1</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="k">value</span> <span class="p">=</span> <span class="n">Item</span><span class="p">.</span><span class="nf">sellPrice</span><span class="p">(</span><span class="n">gold</span><span class="p">:</span> <span class="m">1</span><span class="p">);</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">rare</span> <span class="p">=</span> <span class="n">ItemRarityID</span><span class="p">.</span><span class="n">Blue</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">useAnimation</span> <span class="p">=</span> <span class="m">15</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">useTime</span> <span class="p">=</span> <span class="m">20</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">useStyle</span> <span class="p">=</span> <span class="n">ItemUseStyleID</span><span class="p">.</span><span class="n">HoldUp</span><span class="p">;</span>
            <span class="n">Item</span><span class="p">.</span><span class="n">consumable</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="n">IsMagnetOn</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">AddRecipes</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="c1">// 20个铁锭/铅锭</span>
            <span class="nf">CreateRecipe</span><span class="p">()</span>
                <span class="p">.</span><span class="nf">AddRecipeGroup</span><span class="p">(</span><span class="s">"IronBar"</span><span class="p">,</span> <span class="m">20</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">AddTile</span><span class="p">(</span><span class="n">TileID</span><span class="p">.</span><span class="n">Anvils</span><span class="p">)</span>
                <span class="p">.</span><span class="nf">Register</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span><span class="p">?</span> <span class="nf">UseItem</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">IsMagnetOn</span> <span class="p">=</span> <span class="p">!</span><span class="n">player</span><span class="p">.</span><span class="nf">HasBuff</span><span class="p">(</span><span class="n">ModContent</span><span class="p">.</span><span class="n">BuffType</span><span class="p">&lt;</span><span class="n">Buffs</span><span class="p">.</span><span class="n">ItemGrabBuff</span><span class="p">&gt;());</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IsMagnetOn</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">CombatText</span><span class="p">.</span><span class="nf">NewText</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">Hitbox</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span> <span class="nf">GetText</span><span class="p">(</span><span class="s">"OnTooltip"</span><span class="p">));</span>
                <span class="n">player</span><span class="p">.</span><span class="nf">AddBuff</span><span class="p">(</span><span class="n">ModContent</span><span class="p">.</span><span class="n">BuffType</span><span class="p">&lt;</span><span class="n">Buffs</span><span class="p">.</span><span class="n">ItemGrabBuff</span><span class="p">&gt;(),</span> <span class="m">2592000</span><span class="p">);</span>
                <span class="n">SoundEngine</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundID</span><span class="p">.</span><span class="n">MenuTick</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">CombatText</span><span class="p">.</span><span class="nf">NewText</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">Hitbox</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span> <span class="nf">GetText</span><span class="p">(</span><span class="s">"OffTooltip"</span><span class="p">));</span>
                <span class="n">player</span><span class="p">.</span><span class="nf">ClearBuff</span><span class="p">(</span><span class="n">ModContent</span><span class="p">.</span><span class="n">BuffType</span><span class="p">&lt;</span><span class="n">Buffs</span><span class="p">.</span><span class="n">ItemGrabBuff</span><span class="p">&gt;());</span>
                <span class="n">SoundEngine</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundID</span><span class="p">.</span><span class="n">MenuClose</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ModifyTooltips</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">TooltipLine</span><span class="p">&gt;</span> <span class="n">tooltips</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">color</span> <span class="p">=</span> <span class="n">IsMagnetOn</span> <span class="p">?</span> <span class="s">"00FF00"</span> <span class="p">:</span> <span class="s">"FF0000"</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">tooltop</span> <span class="p">=</span> <span class="n">IsMagnetOn</span> <span class="p">?</span> <span class="nf">GetText</span><span class="p">(</span><span class="s">"OnTooltip"</span><span class="p">)</span> <span class="p">:</span> <span class="nf">GetText</span><span class="p">(</span><span class="s">"OffTooltip"</span><span class="p">);</span>
            <span class="kt">var</span> <span class="n">line</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TooltipLine</span><span class="p">(</span><span class="n">Mod</span><span class="p">,</span> <span class="nf">GetText</span><span class="p">(</span><span class="s">"StatusName"</span><span class="p">),</span> <span class="s">$"[c/</span><span class="p">{</span><span class="n">color</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">tooltop</span><span class="p">}</span><span class="s">]"</span><span class="p">);</span>
            <span class="n">tooltips</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div></div>
<p>然后是物品拾取范围扩大的实现。新定义<code class="language-plaintext highlighter-rouge">EasyBuildModGlobalItem</code>继承自<code class="language-plaintext highlighter-rouge">GlobalItem</code>，重写其中的GrabRange方法。注意格子数与游戏实际距离的换算是乘除16。</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">EasyBuildModGlobalItem</span> <span class="p">:</span> <span class="n">GlobalItem</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">GrabRange</span><span class="p">(</span><span class="n">Item</span> <span class="n">item</span><span class="p">,</span> <span class="n">Player</span> <span class="n">player</span><span class="p">,</span> <span class="k">ref</span> <span class="kt">int</span> <span class="n">grabRange</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">GetModPlayer</span><span class="p">&lt;</span><span class="n">EasyBuildModPlayer</span><span class="p">&gt;().</span><span class="n">ItemGrabBuff</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">grabRange</span> <span class="p">=</span> <span class="n">ModContent</span><span class="p">.</span><span class="n">GetInstance</span><span class="p">&lt;</span><span class="n">EasyBuildModConfig</span><span class="p">&gt;().</span><span class="n">MagnetRange</span> <span class="p">*</span> <span class="m">16</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>至此便基本实现了ItemGrabMagnet的功能。效果如下：
<img src="/post_assets/images/2023/03/25-itemgrabmagnet-1.png" alt="" />
<img src="/post_assets/images/2023/03/25-itemgrabmagnet-2.png" alt="" /></p>

<h3 id="22物块放置与摧毁助手基类">2.2物块放置与摧毁助手基类</h3>
<p>ItemPlaceHelper与ItemDestroyHelper二者都有共同的特点，一个是可以通过右键调出菜单进行选择，一个是左键可以框选区域进行放置或破坏。自己最开始是先写了ItemPlaceHelper，而后写另一个的时候才意识到有大量重复的逻辑。为了避免过多重复代码，这里就二者的共同特点提取出一个抽象基类。
这里分成了三部分，物品自身、菜单和区域选择。</p>
<h4 id="221item实现">2.2.1Item实现</h4>
<p>主要就是定义了物品的基本行为，如右键调出菜单，左键进行框选。调出菜单在重写<code class="language-plaintext highlighter-rouge">CanUseItem</code>中进行实现，选择区域则是在<code class="language-plaintext highlighter-rouge">UseItem</code>，这样处理更为方便。这种情况下，<code class="language-plaintext highlighter-rouge">ItemPlaceHelper</code>与<code class="language-plaintext highlighter-rouge">ItemDestroyHelper</code>只需重写<code class="language-plaintext highlighter-rouge">StartAction</code>方法即可。
这部分核心代码如下:</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">AreaSelectItem</span> <span class="p">:</span> <span class="n">ModItem</span>
    <span class="p">{</span>
        <span class="c1">// 选择区域的起点和终点</span>
        <span class="k">protected</span> <span class="n">Point</span> <span class="n">_beginPoint</span><span class="p">;</span>
        <span class="k">protected</span> <span class="n">Point</span> <span class="n">_endPoint</span><span class="p">;</span>

        <span class="c1">// 是否开始选择区域</span>
        <span class="k">protected</span> <span class="kt">bool</span> <span class="n">_startSelecting</span><span class="p">;</span>

        <span class="c1">// 菜单UI的静态实例</span>
        <span class="k">protected</span> <span class="n">MenuUI</span> <span class="n">_menuUI</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">AltFunctionUse</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>

        <span class="k">protected</span> <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">useItemCondition</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">true</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">CanUseItem</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">UISystem</span><span class="p">.</span><span class="n">CurrentMenuUI</span> <span class="p">=</span> <span class="n">_menuUI</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">noBuilding</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">altFunctionUse</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">_menuUI</span><span class="p">.</span><span class="n">Visible</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">SoundEngine</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundID</span><span class="p">.</span><span class="n">MenuClose</span><span class="p">);</span>
                    <span class="n">_menuUI</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">SoundEngine</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundID</span><span class="p">.</span><span class="n">MenuTick</span><span class="p">);</span>
                    <span class="n">_menuUI</span><span class="p">.</span><span class="nf">Open</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(!</span><span class="nf">useItemCondition</span><span class="p">(</span><span class="n">player</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">_startSelecting</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_beginPoint</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MouseWorld</span><span class="p">.</span><span class="nf">ToTileCoordinates</span><span class="p">();</span>
                <span class="n">_startSelecting</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span><span class="p">?</span> <span class="nf">UseItem</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_endPoint</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MouseWorld</span><span class="p">.</span><span class="nf">ToTileCoordinates</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseLeft</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">HandleMouseUp</span><span class="p">();</span>
                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseRight</span> <span class="p">&amp;&amp;</span> <span class="n">_startSelecting</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">StopUse</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">DrawingSystem</span><span class="p">.</span><span class="nf">StartDraw</span><span class="p">(</span><span class="nf">GetRectangle</span><span class="p">(</span><span class="n">_beginPoint</span><span class="p">,</span> <span class="n">_endPoint</span><span class="p">));</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="k">base</span><span class="p">.</span><span class="nf">UseItem</span><span class="p">(</span><span class="n">player</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">StopUse</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">DrawingSystem</span><span class="p">.</span><span class="nf">StopDraw</span><span class="p">();</span>
            <span class="n">_startSelecting</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">HandleMouseUp</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">_startSelecting</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">StartAction</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">LocalPlayer</span><span class="p">);</span>
                <span class="n">SoundEngine</span><span class="p">.</span><span class="nf">PlaySound</span><span class="p">(</span><span class="n">SoundID</span><span class="p">.</span><span class="n">Dig</span><span class="p">);</span>
                <span class="nf">StopUse</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">protected</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">StartAction</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span>
        <span class="p">{</span>
        <span class="p">}</span>
                
    <span class="p">}</span>
</code></pre></div></div>

<h4 id="222菜单实现">2.2.2菜单实现</h4>
<p>由于任意一个ItemPlaceHelper所调出的菜单都相同，所以就没必要给每一个ItemPlaceHelper配一个菜单，所有ItemPlaceHelper共用一个菜单即可。菜单继承自<code class="language-plaintext highlighter-rouge">Terraria.UI.UIState</code>，菜单的正确显示也花了不少时间，经过查看源码以及参考了”更好的体验”模组最后终于将UI显示出来。
显示菜单的基本层次结构是<code class="language-plaintext highlighter-rouge">ModSystem -&gt; UserInterface -&gt; UIState -&gt; UIElement</code>。具体就是UI中由若干像按钮之类的UIElement构成，UI的显示需要通过用户接口去更新UI状态，<code class="language-plaintext highlighter-rouge">UIState</code>与<code class="language-plaintext highlighter-rouge">UserInterface</code>的静态变量都存储在一个ModSystem中，让其可以在模组加载时就被加载好，并通过重写ModSystem的<code class="language-plaintext highlighter-rouge">UpdateUI</code>和<code class="language-plaintext highlighter-rouge">ModifyInterfaceLayers</code>去实现UI的更新与绘制。
<code class="language-plaintext highlighter-rouge">UISystem</code>的核心代码如下：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">UISystem</span> <span class="p">:</span> <span class="n">ModSystem</span>
    <span class="p">{</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">ItemPlaceHelperUI</span> <span class="n">ItemPlaceHelperUI</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">UserInterface</span> <span class="n">_itemPlaceHelperInterface</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">static</span> <span class="n">ItemDestroyHelperUI</span> <span class="n">ItemDestroyHelperUI</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
        <span class="k">private</span> <span class="k">static</span> <span class="n">UserInterface</span> <span class="n">_itemDestroyHelperInterface</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Load</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ItemPlaceHelperUI</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ItemPlaceHelperUI</span><span class="p">();</span>
            <span class="n">_itemPlaceHelperInterface</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UserInterface</span><span class="p">();</span>
            <span class="n">_itemPlaceHelperInterface</span><span class="p">.</span><span class="nf">SetState</span><span class="p">(</span><span class="n">ItemPlaceHelperUI</span><span class="p">);</span>
            <span class="n">ItemDestroyHelperUI</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ItemDestroyHelperUI</span><span class="p">();</span>
            <span class="n">_itemDestroyHelperInterface</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UserInterface</span><span class="p">();</span>
            <span class="n">_itemDestroyHelperInterface</span><span class="p">.</span><span class="nf">SetState</span><span class="p">(</span><span class="n">ItemDestroyHelperUI</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">Unload</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">ItemPlaceHelperUI</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">_itemPlaceHelperInterface</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">ItemDestroyHelperUI</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
            <span class="n">_itemDestroyHelperInterface</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">UpdateUI</span><span class="p">(</span><span class="n">GameTime</span> <span class="n">gameTime</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ItemPlaceHelperUI</span><span class="p">.</span><span class="n">Visible</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_itemPlaceHelperInterface</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ItemDestroyHelperUI</span><span class="p">.</span><span class="n">Visible</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">_itemDestroyHelperInterface</span><span class="p">.</span><span class="nf">Update</span><span class="p">(</span><span class="n">gameTime</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ModifyInterfaceLayers</span><span class="p">(</span><span class="n">List</span><span class="p">&lt;</span><span class="n">GameInterfaceLayer</span><span class="p">&gt;</span> <span class="n">layers</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">mouseTextIndex</span> <span class="p">=</span> <span class="n">layers</span><span class="p">.</span><span class="nf">FindIndex</span><span class="p">(</span><span class="n">layer</span> <span class="p">=&gt;</span> <span class="n">layer</span><span class="p">.</span><span class="n">Name</span><span class="p">.</span><span class="nf">Equals</span><span class="p">(</span><span class="s">"Vanilla: Mouse Text"</span><span class="p">));</span> <span class="c1">// 表示在鼠标文本之上</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mouseTextIndex</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">layers</span><span class="p">.</span><span class="nf">Insert</span><span class="p">(</span><span class="n">mouseTextIndex</span><span class="p">,</span> <span class="k">new</span> <span class="nf">LegacyGameInterfaceLayer</span><span class="p">(</span>
                    <span class="s">"EasyBuildMod: MyMenuUI"</span><span class="p">,</span>
                    <span class="k">delegate</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ItemPlaceHelperUI</span><span class="p">.</span><span class="n">Visible</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">_itemPlaceHelperInterface</span><span class="p">.</span><span class="nf">Draw</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">spriteBatch</span><span class="p">,</span> <span class="k">new</span> <span class="nf">GameTime</span><span class="p">());</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ItemDestroyHelperUI</span><span class="p">.</span><span class="n">Visible</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">_itemDestroyHelperInterface</span><span class="p">.</span><span class="nf">Draw</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">spriteBatch</span><span class="p">,</span> <span class="k">new</span> <span class="nf">GameTime</span><span class="p">());</span>
                        <span class="p">}</span>
                        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
                    <span class="p">},</span>
                    <span class="n">InterfaceScaleType</span><span class="p">.</span><span class="n">UI</span><span class="p">)</span>
                <span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div></div>
<p>可以看到存在这样的调用顺序<code class="language-plaintext highlighter-rouge">ModSystem.UpdateUI -&gt; UseInterface.Update</code>用于实时更新,  <code class="language-plaintext highlighter-rouge">ModSystem.ModifyInterfaceLayers -&gt; UseInterface.Draw</code>用于绘制。而这里给UI添加了个变量<code class="language-plaintext highlighter-rouge">Visible</code>用于控制何时显示。只有当<code class="language-plaintext highlighter-rouge">Visible</code>为true时上述两个方法才对其进行更新。</p>

<p>接下来是UI，UI中的代码比较简单，由于所有物品共用一个UI，所以这里需要存储调出UI的物品是哪一个(<code class="language-plaintext highlighter-rouge">AreaSelectItem</code>)。在其派生类中只需定义包含的元素以及相应的点击事件等即可。
这里有一个需要注意的点就是UI的位置需要考虑用户的UI缩放。
<img src="/post_assets/images/2023/03/25-terraria-ui-zoom.png" alt="" />
这部分核心代码如下：</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">MenuUI</span> <span class="p">:</span> <span class="n">UIState</span>
    <span class="p">{</span>
        <span class="k">internal</span> <span class="n">AreaSelectItem</span> <span class="n">AreaSelectItem</span><span class="p">;</span>

        <span class="k">protected</span> <span class="n">UIElement</span> <span class="n">MainContainer</span><span class="p">;</span>

        <span class="k">public</span> <span class="kt">bool</span> <span class="n">Visible</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">OnInitialize</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="k">base</span><span class="p">.</span><span class="nf">OnInitialize</span><span class="p">();</span>
            <span class="nf">Append</span><span class="p">(</span><span class="n">MainContainer</span> <span class="p">=</span> <span class="k">new</span> <span class="p">());</span>
            <span class="n">MainContainer</span><span class="p">.</span><span class="n">Width</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">MainContainer</span><span class="p">.</span><span class="n">Height</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">virtual</span> <span class="k">void</span> <span class="nf">Open</span><span class="p">(</span><span class="n">AreaSelectItem</span> <span class="n">item</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="n">AreaSelectItem</span> <span class="p">=</span> <span class="n">item</span><span class="p">;</span>
            <span class="n">Visible</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="c1">// 注意要除以UIScale，否则如果缩放比例不是100%就会错位</span>
            <span class="n">MainContainer</span><span class="p">.</span><span class="n">Left</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseX</span> <span class="p">/</span> <span class="n">Main</span><span class="p">.</span><span class="n">UIScale</span> <span class="p">-</span> <span class="n">MainContainer</span><span class="p">.</span><span class="n">Width</span><span class="p">.</span><span class="n">Pixels</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="n">MainContainer</span><span class="p">.</span><span class="n">Top</span><span class="p">.</span><span class="nf">Set</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseY</span> <span class="p">/</span> <span class="n">Main</span><span class="p">.</span><span class="n">UIScale</span> <span class="p">-</span> <span class="n">MainContainer</span><span class="p">.</span><span class="n">Height</span><span class="p">.</span><span class="n">Pixels</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div></div>

<p>当玩家手中物品切换时，也需要关闭UI，这里需要在<code class="language-plaintext highlighter-rouge">ModPlayer</code>中重写<code class="language-plaintext highlighter-rouge">PostUpdate</code>方法，当玩家手中物品不是<code class="language-plaintext highlighter-rouge">AreaSelectItem</code>时关闭UI。</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">PostUpdate</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">UISystem</span><span class="p">.</span><span class="n">CurrentMenuUI</span> <span class="k">is</span> <span class="k">null</span> <span class="p">||</span> <span class="n">UISystem</span><span class="p">.</span><span class="n">CurrentMenuUI</span><span class="p">.</span><span class="n">AreaSelectItem</span> <span class="k">is</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">AreaSelectItem</span> <span class="n">currentItem</span> <span class="p">=</span> <span class="n">UISystem</span><span class="p">.</span><span class="n">CurrentMenuUI</span><span class="p">.</span><span class="n">AreaSelectItem</span><span class="p">;</span>
        <span class="n">Player</span> <span class="n">player</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">player</span><span class="p">[</span><span class="n">Main</span><span class="p">.</span><span class="n">myPlayer</span><span class="p">];</span>
        <span class="n">Item</span> <span class="n">item</span> <span class="p">=</span> <span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">player</span><span class="p">.</span><span class="n">selectedItem</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">type</span> <span class="p">!=</span> <span class="n">currentItem</span><span class="p">.</span><span class="n">Type</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">Main</span><span class="p">.</span><span class="n">playerInventory</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">UISystem</span><span class="p">.</span><span class="nf">Hide</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">DrawingSystem</span><span class="p">.</span><span class="nf">Init</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseLeft</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">UISystem</span><span class="p">.</span><span class="n">CurrentMenuUI</span><span class="p">.</span><span class="n">AreaSelectItem</span><span class="p">.</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<h4 id="223物块选择框实现">2.2.3物块选择框实现</h4>
<p>这里也一样需要通过在<code class="language-plaintext highlighter-rouge">ModSystem</code>的<code class="language-plaintext highlighter-rouge">ModifyInterfaceLayers</code>调用对应<code class="language-plaintext highlighter-rouge">UserInterface</code>的<code class="language-plaintext highlighter-rouge">Draw</code>进行绘制。新定义一个<code class="language-plaintext highlighter-rouge">DrawingSystem</code>继承自<code class="language-plaintext highlighter-rouge">ModSystem</code>，这部分代码就不多赘述了。
物品框选时希望显示的有(1)在鼠标末尾画物块预览 (2)矩形区域预览 (3) 矩形大小显示，其中(2)和(3)只有在使用物品时才进行绘制。这部分核心代码如下：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">class</span> <span class="nc">SelectedAreaDrawing</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsDrawing</span><span class="p">;</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 绘制物块预览</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">drawItemPreview</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Vector2</span> <span class="n">position</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MouseScreen</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">32</span><span class="p">,</span> <span class="m">32</span><span class="p">);</span>
            <span class="n">Texture2D</span> <span class="n">texture</span> <span class="p">=</span> <span class="n">TextureAssets</span><span class="p">.</span><span class="n">Item</span><span class="p">[</span><span class="n">itemId</span><span class="p">].</span><span class="n">Value</span><span class="p">;</span>
            <span class="n">Main</span><span class="p">.</span><span class="n">spriteBatch</span><span class="p">.</span><span class="nf">Draw</span><span class="p">(</span><span class="n">texture</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">texture</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="n">SpriteEffects</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">0f</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 绘制矩形区域预览</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">drawRectanglePreview</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Vector2</span> <span class="n">leftTop</span> <span class="p">=</span> <span class="n">_rectangle</span><span class="p">.</span><span class="nf">TopLeft</span><span class="p">()</span> <span class="p">*</span> <span class="m">16</span> <span class="p">-</span> <span class="n">Main</span><span class="p">.</span><span class="n">screenPosition</span><span class="p">;</span>
            <span class="n">Vector2</span> <span class="n">size</span> <span class="p">=</span> <span class="n">_rectangle</span><span class="p">.</span><span class="nf">Size</span><span class="p">()</span> <span class="p">*</span> <span class="m">16</span><span class="p">;</span>
            <span class="n">Color</span> <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span> <span class="p">*</span> <span class="m">0.7f</span><span class="p">;</span>
            <span class="n">_areaTexture</span><span class="p">.</span><span class="nf">SetData</span><span class="p">(</span><span class="k">new</span> <span class="n">Color</span><span class="p">[]</span> <span class="p">{</span> <span class="n">color</span> <span class="p">});</span>
            <span class="n">Main</span><span class="p">.</span><span class="n">spriteBatch</span><span class="p">.</span><span class="nf">Draw</span><span class="p">(</span><span class="n">_areaTexture</span><span class="p">,</span> <span class="n">leftTop</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">SpriteEffects</span><span class="p">.</span><span class="n">None</span><span class="p">,</span> <span class="m">0f</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">/// &lt;summary&gt;</span>
        <span class="c1">/// 标明矩形大小</span>
        <span class="c1">/// &lt;/summary&gt;</span>
        <span class="k">private</span> <span class="k">void</span> <span class="nf">drawRectangleSize</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">sizeText</span> <span class="p">=</span> <span class="s">$"</span><span class="p">{</span><span class="n">_rectangle</span><span class="p">.</span><span class="n">Width</span><span class="p">}</span><span class="s"> x </span><span class="p">{</span><span class="n">_rectangle</span><span class="p">.</span><span class="n">Height</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
            <span class="n">Vector2</span> <span class="n">size</span> <span class="p">=</span> <span class="n">FontAssets</span><span class="p">.</span><span class="n">MouseText</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">MeasureString</span><span class="p">(</span><span class="n">sizeText</span><span class="p">);</span>
            <span class="n">Vector2</span> <span class="n">position</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">MouseScreen</span> <span class="p">+</span> <span class="k">new</span> <span class="nf">Vector2</span><span class="p">(</span><span class="m">16</span><span class="p">,</span> <span class="p">-</span><span class="n">size</span><span class="p">.</span><span class="n">Y</span> <span class="p">-</span> <span class="m">6</span><span class="p">);</span>
            <span class="n">ChatManager</span><span class="p">.</span><span class="nf">DrawColorCodedStringWithShadow</span><span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">spriteBatch</span><span class="p">,</span> <span class="n">FontAssets</span><span class="p">.</span><span class="n">MouseText</span><span class="p">.</span><span class="n">Value</span><span class="p">,</span> <span class="n">sizeText</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">Vector2</span><span class="p">.</span><span class="n">One</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Draw</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nf">drawItemPreview</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">IsDrawing</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="nf">drawRectanglePreview</span><span class="p">();</span>
                <span class="nf">drawRectangleSize</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p><img src="/post_assets/images/2023/03/25-sphere-select.png" alt="" /></p>

<h3 id="23物块放置助手">2.3物块放置助手</h3>
<p>ItemPlaceHelper，想要实现的效果是右键打开物品选择菜单，选择物品后，左键可以选择矩形区域放置。
选择菜单中只有一个用于放置选择物块的按钮，通过获取Main.mouseItem物品，根据其createTile和createWall判断是否为物块或墙壁，这部分代码如下：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">itemSelectButton</span><span class="p">.</span><span class="n">OnClick</span> <span class="p">+=</span> <span class="p">(</span><span class="n">evt</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">type</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 如果物块可以放置，则添加进来</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">createTile</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span> <span class="p">&amp;&amp;</span> <span class="n">Main</span><span class="p">.</span><span class="n">tileSolid</span><span class="p">[</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">createTile</span><span class="p">])</span> <span class="p">||</span> <span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">createWall</span> <span class="p">!=</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">AreaSelectItem</span><span class="p">.</span><span class="n">ContentItemType</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
                <span class="n">itemSelectButton</span><span class="p">.</span><span class="nf">SetContent</span><span class="p">(</span><span class="n">TextureAssets</span><span class="p">.</span><span class="n">Item</span><span class="p">[</span><span class="n">Main</span><span class="p">.</span><span class="n">mouseItem</span><span class="p">.</span><span class="n">type</span><span class="p">]);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">itemSelectButton</span><span class="p">.</span><span class="nf">SetContent</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
            <span class="n">AreaSelectItem</span><span class="p">.</span><span class="n">ContentItemType</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>
</code></pre></div></div>
<p>其中<code class="language-plaintext highlighter-rouge">itemSelectButton</code>是自己定义的一个圆形按钮。</p>

<p>该物品的关键在于放置物品，即重写基类<code class="language-plaintext highlighter-rouge">AreaSelectItem</code>的<code class="language-plaintext highlighter-rouge">StartAction</code>方法。</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">protected</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">StartAction</span><span class="p">(</span><span class="n">Player</span> <span class="n">player</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">rect</span> <span class="p">=</span> <span class="nf">GetRectangle</span><span class="p">(</span><span class="n">_beginPoint</span><span class="p">,</span> <span class="n">_endPoint</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">consumeCount</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">total</span> <span class="p">=</span> <span class="nf">GetItemCountOfInventory</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">,</span> <span class="n">ContentItemType</span><span class="p">);</span>
        <span class="n">Item</span> <span class="n">item</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Item</span><span class="p">();</span>
        <span class="n">item</span><span class="p">.</span><span class="nf">SetDefaults</span><span class="p">(</span><span class="n">ContentItemType</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">isWall</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">createWall</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">hasHammer</span> <span class="p">=</span> <span class="nf">getMaxHammerPower</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">;</span>
        <span class="c1">// 从下到上，从左到右</span>
        <span class="c1">// 这种顺序可以保证某些具有自由落体性质的方块(如沙块)能够被正确的放置</span>
        <span class="c1">// 不过也会导致替换方块时, 像沙块这样的方块无法被从下往上替换</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span> <span class="n">rect</span><span class="p">.</span><span class="n">Y</span> <span class="p">+</span> <span class="n">rect</span><span class="p">.</span><span class="n">Height</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span> <span class="n">y</span> <span class="p">&gt;=</span> <span class="n">rect</span><span class="p">.</span><span class="n">Y</span><span class="p">;</span> <span class="n">y</span><span class="p">--)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="n">rect</span><span class="p">.</span><span class="n">X</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">rect</span><span class="p">.</span><span class="n">X</span> <span class="p">+</span> <span class="n">rect</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">consumeCount</span> <span class="p">&gt;=</span> <span class="n">total</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">Tile</span> <span class="n">tile</span> <span class="p">=</span> <span class="n">Main</span><span class="p">.</span><span class="n">tile</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">];</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">isWall</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tile</span><span class="p">.</span><span class="n">WallType</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(!</span><span class="n">player</span><span class="p">.</span><span class="n">TileReplacementEnabled</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">hasHammer</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="n">WorldGen</span><span class="p">.</span><span class="nf">KillWall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="k">false</span><span class="p">);</span>
                            <span class="n">WorldGen</span><span class="p">.</span><span class="nf">PlaceWall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">ushort</span><span class="p">)</span><span class="n">item</span><span class="p">.</span><span class="n">createWall</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
                            <span class="n">consumeCount</span><span class="p">++;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">WorldGen</span><span class="p">.</span><span class="nf">PlaceWall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">ushort</span><span class="p">)</span><span class="n">item</span><span class="p">.</span><span class="n">createWall</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
                        <span class="n">consumeCount</span><span class="p">++;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">tile</span><span class="p">.</span><span class="n">HasTile</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(!</span><span class="n">player</span><span class="p">.</span><span class="n">TileReplacementEnabled</span> <span class="p">||</span> <span class="p">!</span><span class="n">player</span><span class="p">.</span><span class="nf">HasEnoughPickPowerToHurtTile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
                        <span class="p">{</span>
                            <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="c1">// 判断是否是同一种方块，是则跳过</span>
                        <span class="n">WorldGen</span><span class="p">.</span><span class="nf">KillTile_GetItemDrops</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">tile</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">tileType</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">,</span> <span class="k">out</span> <span class="n">_</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">tileType</span> <span class="p">==</span> <span class="n">item</span><span class="p">.</span><span class="n">type</span><span class="p">)</span>
                        <span class="p">{</span>
                            <span class="k">continue</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">WorldGen</span><span class="p">.</span><span class="nf">ReplaceTile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">ushort</span><span class="p">)</span><span class="n">item</span><span class="p">.</span><span class="n">createTile</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">placeStyle</span><span class="p">))</span>
                        <span class="p">{</span>
                            <span class="n">consumeCount</span><span class="p">++;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">WorldGen</span><span class="p">.</span><span class="nf">PlaceTile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="kt">ushort</span><span class="p">)</span><span class="n">item</span><span class="p">.</span><span class="n">createTile</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="k">true</span><span class="p">,</span> <span class="n">player</span><span class="p">.</span><span class="n">whoAmI</span><span class="p">,</span> <span class="n">item</span><span class="p">.</span><span class="n">placeStyle</span><span class="p">))</span>
                        <span class="p">{</span>
                            <span class="n">consumeCount</span><span class="p">++;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">consumeCount</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
            <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span> <span class="p">==</span> <span class="n">ContentItemType</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stack</span> <span class="p">&gt;</span> <span class="n">consumeCount</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stack</span> <span class="p">-=</span> <span class="n">consumeCount</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">consumeCount</span> <span class="p">-=</span> <span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stack</span><span class="p">;</span>
                        <span class="n">player</span><span class="p">.</span><span class="n">inventory</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">SetDefaults</span><span class="p">();</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>以上有几个需要注意的问题，</p>
<ol>
  <li>如果使用<code class="language-plaintext highlighter-rouge">player.PickTile</code>进行破坏物块，则第三个参数镐力值需要尽可能的填大一些，如果镐力刚好大于物块所需的最大镐力，则完全有可能不能直接摧毁物块而仅仅是对其造成一定程度损坏</li>
  <li>替换物块可以用<code class="language-plaintext highlighter-rouge">WorldGen.ReplaceTile</code>但替换墙壁则没找到对应的<code class="language-plaintext highlighter-rouge">ReplaceWall</code>，需要先使用<code class="language-plaintext highlighter-rouge">KillWall</code>再进行放置。</li>
  <li>获取位于x,y处的物块或墙壁的类型的问题放在了文章末尾 <a href="#2.获取物块或墙壁对应的类型">点这里跳转</a></li>
</ol>

<h3 id="24物块摧毁助手">2.4物块摧毁助手</h3>
<p>ItemDestroyHelper，设计思路与ItemPlaceHelper几乎完全相同，只是将<code class="language-plaintext highlighter-rouge">StartAction</code>中的放置改为了摧毁，实际上摧毁的逻辑在替换物块时已经实现，这里就不多赘述。
<img src="/post_assets/images/2023/03/25-destroy-helper.png" alt="" /></p>

<h2 id="3多人模式下的相关修改">3.多人模式下的相关修改</h2>
<p>这部分主要集中在物块墙壁放置和摧毁时与游戏内其他玩家的同步问题上，于是我就在摧毁和放置的末尾加上：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="p">(</span><span class="n">Main</span><span class="p">.</span><span class="n">netMode</span> <span class="p">==</span> <span class="n">NetmodeID</span><span class="p">.</span><span class="n">MultiplayerClient</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">NetMessage</span><span class="p">.</span><span class="nf">SendData</span><span class="p">(</span><span class="n">MessageID</span><span class="p">.</span><span class="n">TileSquare</span><span class="p">,</span> <span class="n">Main</span><span class="p">.</span><span class="n">myPlayer</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">X</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">Y</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">rect</span><span class="p">.</span><span class="n">Height</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>
<p>这样一次性同步范围内的所有方块。但这时也遇到了个问题，虽然方块同步了，但却没有掉落物。摧毁物块和墙壁调用的是<code class="language-plaintext highlighter-rouge">WorldGen.KillTile</code>和<code class="language-plaintext highlighter-rouge">WorldGen.KillWall</code>，仔细查看源码才发现当游戏处于多人模式时，这两个方法禁用了物块的正常掉落。
<img src="/post_assets/images/2023/03/25-tmodloader-source-1.png" alt="" />
这时我注意到另一个函数<code class="language-plaintext highlighter-rouge">player.PickTile(x, y, 10000)</code>在进行破坏物块时可以在多人模式下掉落，于是我进入Player的PickTile方法中查看了一下，如下图所示：
<img src="/post_assets/images/2023/03/25-tmodloader-source-2.png" alt="" />
仿照这个方法，我重新写了一下破坏物块和墙壁的代码，注意墙壁和物块的<code class="language-plaintext highlighter-rouge">SendData</code>第五个参数不同：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">WallUtils</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">KillWall</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fail</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">WorldGen</span><span class="p">.</span><span class="nf">KillWall</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fail</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">fail</span> <span class="p">&amp;&amp;</span> <span class="n">Main</span><span class="p">.</span><span class="n">netMode</span> <span class="p">==</span> <span class="n">NetmodeID</span><span class="p">.</span><span class="n">MultiplayerClient</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Wall对应的SendData第5个参数值为2</span>
                <span class="n">NetMessage</span><span class="p">.</span><span class="nf">SendData</span><span class="p">(</span><span class="n">MessageID</span><span class="p">.</span><span class="n">TileManipulation</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">TileUtils</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">KillTile</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">fail</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">effectOnly</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">noItem</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">WorldGen</span><span class="p">.</span><span class="nf">KillTile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">fail</span><span class="p">,</span> <span class="n">effectOnly</span><span class="p">,</span> <span class="n">noItem</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(!</span><span class="n">fail</span> <span class="p">&amp;&amp;</span> <span class="n">Main</span><span class="p">.</span><span class="n">netMode</span> <span class="p">==</span> <span class="n">NetmodeID</span><span class="p">.</span><span class="n">MultiplayerClient</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="c1">// Tile对应的SendData第5个参数值为0</span>
                <span class="n">NetMessage</span><span class="p">.</span><span class="nf">SendData</span><span class="p">(</span><span class="n">MessageID</span><span class="p">.</span><span class="n">TileManipulation</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="p">-</span><span class="m">1</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="kt">float</span><span class="p">)</span><span class="n">y</span><span class="p">,</span> <span class="m">0f</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="p">}</span>
</code></pre></div></div>

<h2 id="4开发过程中的其他问题">4.开发过程中的其他问题</h2>
<h3 id="1使用语言文件时遇到的问题">1.使用语言文件时遇到的问题</h3>
<p>将模组中需要用到的文字信息的不同语言版本放在XXX.hjson如en-US.hjson中，再通过Language.GetTextValue(“Mods.XXX.XXX”)来获取对应语言的文字。但在我使用时遇到一个小问题，在设置物品的DisplayName和Tooltip的名称时，以下代码并不能正常获取到对应语言的文字信息：</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">DisplayName</span><span class="p">.</span><span class="nf">SetDefault</span><span class="p">(</span><span class="n">Language</span><span class="p">.</span><span class="nf">GetTextValue</span><span class="p">(</span><span class="s">"Mods.XXX.XXX"</span><span class="p">));</span>
    <span class="n">Tooltip</span><span class="p">.</span><span class="nf">SetDefault</span><span class="p">(</span><span class="n">Language</span><span class="p">.</span><span class="nf">GetTextValue</span><span class="p">(</span><span class="s">"Mods.XXX.XXX"</span><span class="p">));</span>
</code></pre></div></div>
<p>在游戏运行时有时能正常显示，有时则直接显示了“Mods.XXXXXX”这个字符串。推测是语言文件与物品静态信息加载顺序关。后面参考了官方的ExampleMod，解决方法是在语言文件hjson中直接写明物品或Buff的DisplayName和Tooltip，会自动读取到游戏中。</p>
<pre><code class="language-hjson">    Mods.XXXMod.ItemName: {
        物品类名: 物品名称
    }
    Mods.XXXMod.ItemTooltip: {
        物品类名: 物品Tooltip
    }
    Mods.XXXMod.BuffName: {
        Buff类名: Buff名称
    }
    Mods.XXXMod.BuffDescription: {
        Buff类名: Buff描述
    }
</code></pre>
<h3 id="2获取物块或墙壁对应的类型">2.获取物块或墙壁对应的类型</h3>
<p>判断位于x,y处的物块对应的item的类型，也就是itemId。这个方法我找了很久，最后也是成功从掉落物块的相关源码中找到了直接想要的内容：<code class="language-plaintext highlighter-rouge">Terraria.WorldGen.KillTile_DropItems</code>是用于破坏物块后进行掉落用的，不过它是私有方法，而它调用的<code class="language-plaintext highlighter-rouge">KillTile_GetItemDrops</code>刚好是public方法，所以在判断物块时就使用了这种方法。但是奇怪的是<code class="language-plaintext highlighter-rouge">KillWall_GetItemDrops</code>却是私有方法，所以这里直接将源码中的代码复制过来，如下图所示：
<img src="/post_assets/images/2023/03/25-tmodloader-source-3.png" alt="" />
由于是反编译得到的源码，所以有大量的<code class="language-plaintext highlighter-rouge">switch-case</code>和<code class="language-plaintext highlighter-rouge">if</code>分支。唯一要注意的是图中<code class="language-plaintext highlighter-rouge">*tileCache.wall</code>是<code class="language-plaintext highlighter-rouge">Tile</code>的<code class="language-plaintext highlighter-rouge">internal</code>属性：
<img src="/post_assets/images/2023/03/25-tmodloader-source-4.png" alt="" />
图中可以看到实际上<code class="language-plaintext highlighter-rouge">wall</code>对应的实际就是公有属性<code class="language-plaintext highlighter-rouge">WallType</code>，故将源码中的<code class="language-plaintext highlighter-rouge">*tileCache.wall</code>全改为<code class="language-plaintext highlighter-rouge">tileCache.WallType</code>即可。</p>

<h3 id="3按钮的点击问题">3.按钮的点击问题</h3>
<p>当鼠标上已经有物块时，点击按钮如果鼠标上的物块可以被正确放在按钮所在的原位置，则系统会优先将物块放置再触发按钮的点击事件。这个由于不是非常影响体验，将鼠标离玩家远一点即可，暂时没去研究解决方法。</p>

<h3 id="4待解决的bug">4.待解决的bug</h3>
<p>多人模式下，有时会出现突然摧毁一大片区域的情况，比如一个玩家正在使用物块摧毁助手的区域选择，此时另一个玩家使用回忆药水或者返回药水，就会导致两名玩家之间的大片区域被摧毁。有点类似于灾厄模组中多人游戏下召唤幻海妖龙失败但是在召唤后使用回忆药水就会突然生成。这个bug暂时还没有时间去研究。</p>


  </article>
</div>

<div class="prev-and-next">
  
  <div>
    <span>上一篇 ：</span><a href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/2023/04/07/Mariadb%E4%B8%AD%E5%90%8C%E6%97%B6%E4%BD%BF%E7%94%A8with%E5%92%8Cinsert-values.html" title="Mariadb中同时使用with和insert values">Mariadb中同时使用with和insert values</a>
  </div>
  
  
  <div>
    <span>下一篇 ：</span><a href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/2023/03/22/Axios-delete%E4%BC%A0%E9%80%92%E6%95%B0%E7%BB%84%E9%97%AE%E9%A2%98.html"
      title="Axios delete传递数组问题">Axios delete传递数组问题</a>
  </div>
  
  <div>
    <span> 版权所有，转载时必须以链接形式注明原始出处</span>
  </div>

</div>

<script>
    // 点击<a>跳转到/pages/tags.html#
    document.querySelectorAll(".index-post-tag a").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/tags.html#" + item.getAttribute("data-tag");
        });
    });
    document.querySelectorAll(".post-header a.category").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/classify.html#" + item.getAttribute("data-tag");
        });
    });

    // 生成目录
    // 获取文章内容的标题
    const headings = document.querySelectorAll(".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6");
    if (headings.length === 0) {
        document.querySelector(".toc-container").classList.add("hidden");
    } else {
        document.querySelector(".toc-container").classList.remove("hidden");
    }
    // 目录容器
    const tocList = document.getElementById("toc-list");
    const tempTocData = []

    // 遍历标题，生成目录
    headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1), 10); // 获取标题级别
        const listItem = document.createElement("li");
        const link = document.createElement("a");

        link.textContent = heading.textContent;
        if (!heading.id) {
            heading.id = heading.textContent.replace(/\s+/g, "-").toLowerCase();
        }
        link.href = `#${heading.id}`;
        listItem.appendChild(link);
        tocList.appendChild(listItem);
        tempTocData.push({
            level: level,
            dom: listItem
        })
    });

    // 设置目录项的左边距
    const minLevel = Math.min(...tempTocData.map(item => item.level))
    tempTocData.forEach(item => {
        let diff = item.level - minLevel
        item.dom.style.marginLeft = diff * 20 + "px"
        if (diff === 0) {
            item.dom.classList.add("root-toc")
        }
    })

</script>

<script type="text/javascript" src="/assets/js/highlight/highlight.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/highlightjs-line-numbers.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/run-highlight.js"></script>

<!-- beaudar评论, 日期+标题作为issue名 -->
<script src="https://beaudar.lipk.org/client.js"
  repo="lxmghct/blog-comments"
  branch="master"
  issue-term="【2023-03-25】 泰拉瑞亚EasyBuildMod便捷建造模组开发"
  theme="github-light"
  loading="false"
  crossorigin="anonymous" async>
</script></div>
          </div>
        


      </div>
    </div>
  </div>

  <div id="back-to-top">
    <a href="#"><i class="fa fa-arrow-circle-up"></i></a>
  </div>

  <footer class="site-footer">

  <div class="footer-col-wrapper">
    <div class="footer-col  footer-col-1">
      <ul class="contact-list">
        <li>lxmghct's blog</li>
        <li><a href="mailto:lxmghct@gmail.com">lxmghct@gmail.com</a></li>
        <li></li>
      </ul>
    </div>

    <div class="footer-col  footer-col-2">
      <div class="social-media-list">
        
        <a class="github" href="https://github.com/lxmghct" target="_blank" title="github"></a>
        
        
        <a class="rss" href="/feed.xml" target="_blank" title="rss"></a>
        
      </div>
    </div>

    <div class="footer-col  footer-col-3">
      <p class="text">学习、实践、分享<br> Learning, Practicing, Sharing</p>
    </div>
  </div>
  <div class="center sitedesc">
    Powered by <a href="http://jekyllrb.com/">Jekyll</a> | Hosted on <a href="https://pages.github.com/">
      Github</a>
  </div>

  <script type="text/javascript" src="/assets/js/jquery.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.js"></script>
  <script type="text/javascript" src="/assets/js/tagutils.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
  <script type="text/javascript" type="module" src="/assets/js/search.js"></script>

</footer>

</body>

</html>