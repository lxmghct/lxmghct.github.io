<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>vue自定义组件 search-box | lxmghct's blog</title>
  <meta name="description"
    content="本文首次发布于博客园：https://www.cnblogs.com/lxm-cnblog/p/17408456.html现在转移到 github pages 上。">


  <link rel="stylesheet" href=" /assets/css/bootstrap.css">
  <link rel="stylesheet" href=" /assets/css/font-awesome.css">
  <link rel="stylesheet" href=" /assets/css/main.css">
  <link rel="stylesheet" href=" /assets/css/layouts/default.css">
  <link rel="stylesheet" href=" /assets/css/highlight/default.min.css">
  <link rel="stylesheet" href=" /assets/css/includes/header.css">
  <link rel="stylesheet" href=" /assets/css/includes/footer.css">
  <link rel="stylesheet" href=" /assets/css/includes/search.css">
  <link rel="stylesheet" href=" /assets/css/includes/pagination.css">
  <link rel="stylesheet" href=" /assets/css/layouts/post.css">
  <link rel="stylesheet" href=" /assets/css/highlight/post-highlight.css">
  <link rel="stylesheet" href=" /assets/css/pages/index.css">
  <link rel="shortcut icon" href="" />
  <link rel="canonical" href="/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/2023/05/17/vue%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6-search-box.html">
  <link rel="alternate" type="application/rss+xml" title="lxmghct's blog" href=" /feed.xml" />
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>


<body>

  <div class="site-header">
	<div class="container">
		<div class="row">
			<div class="navbar navbar-default" role="navigation">

				<div class="navbar-header col-xs-8 col-sm-8 col-md-3 col-lg-3 center">
					<div class="header-title">
						<a href="/" title="首页"></a>
						<i class="fa fa-home fa-2x"></i>
						<a class="site-title" href="/">lxmghct's blog</a>
					</div>
				</div>

				<div class="col-md-6 col-lg-6 hidden-sm hidden-xs center">
					<div class="site-nav">
						<ul class="nav nav-pills">
							<li class="select"><a class="page-link" href="/pages/classify.html">分类</a></li>
							<li class="select"><a class="page-link" href="/pages/archive.html">归档</a></li>
							<li class="select"><a class="page-link" href="/pages/tags.html">标签</a></li>
							<li class="select"><a class="page-link" href="/pages/about.html">关于</a></li>
						</ul>
					</div>
				</div>

				<div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
					<div id="header-search" class="search-input-container">
						<input id="header-search-input" type="text" class="header-search-input" placeholder="Search">
						<!--搜索图标-->
						<i class="fa fa-search fa-lg search-icon"></i>
					</div>
				</div>

				<!-- 宽度不够时显示 -->
				<div class="hidden-lg hidden-md col-sm-4 col-xs-4">
					<div class="header-hidden-buttons">
						<i class="fa fa-search fa-lg search-icon"></i>
						<i class="fa fa-bars fa-2x menu-icon"></i>
						<!-- 用于控制菜单的显示和隐藏 -->
						<input type="checkbox" id="nav-trigger" class="nav-trigger">
					</div>
				</div>

				<div class="phone-nav">
					<ul>
						<li><a href="/">首 页</a></li>
						<li><a href="/pages/classify.html">分 类</a></li>
						<li><a href="/pages/archive.html">归 档</a></li>
						<li><a href="/pages/tags.html">标 签</a></li>
						<li><a href="/pages/about.html">关 于</a></li>
					</ul>
				</div>

			</div>
		</div>
	</div>
</div>

<!--遮罩层-->
<div class="search-mask"></div>
<div class="search-container">
  <!-- 右上角关闭按钮 -->
  <i class="fa fa-times fa-2x search-container-close"></i>
  <div class="search-container-main">
    <div class="search-container-wrapper">
      <div class="search-input-container">
        <input type="text" class="search-input" placeholder="Search">
        <!--搜索图标-->
        <i class="fa fa-search fa-lg search-icon search-start"></i>
        <!--关闭图标-->
        <i class="fa fa-times fa-lg search-icon search-clear"></i>
      </div>
      <div class="search-filter">
        <!--只查找标题选择框-->
        <input type="checkbox" class="search-filter-input">
        <span class="search-filter-text">只查找标题</span>
      </div>
      <div class="search-result-summary"></div>
      <div class="search-result-container">
      </div>
      <div class="search-pagination">
        <!-- pagination.html -->

<div class="my-pagination">
  <ul class="my-pager">
    <li class="active">1</li>
    <li>2</li>
  </ul>
  <span class="my-pagination__sizes">
    <span class="my-pagination__sizes__label">每页</span>
    <select class="my-pagination__sizes__select" autocomplete="off">
      <option>5</option>
      <option>10</option>
      <option>20</option>
    </select>
    <span class="my-pagination__sizes__label">条</span>
  </span>
  <span class="my-pagination__total">共 0 条</span>
  <span class="my-pagination__goto">
    <span class="my-pagination__goto__label">前往</span>
    <input class="my-pagination__goto__input" type="text" />
    <span class="my-pagination__goto__label">页</span>
  </span>
</div>

<script>
  (function () {
    const contentSelector = '.search-result-container';
    const parentSelector = '.search-pagination';
    const contentContainer = document.querySelector(`${contentSelector}`);
    if (!contentContainer || !contentSelector || !parentSelector) {
      console.error("pagination.html: content or parent is not defined");
      return;
    }
    const pageItems = []
    const pagerContainer = document.querySelector(`${parentSelector} .my-pager`);
    const totalContainer = document.querySelector(`${parentSelector} .my-pagination__total`);
    const sizesSelect = document.querySelector(`${parentSelector} .my-pagination__sizes__select`);
    const gotoInput = document.querySelector(`${parentSelector} .my-pagination__goto__input`);

    const paginationData = {
      total: 0,
      pageSize: 10,
      currentPage: 1
    }
    sizesSelect.value = paginationData.pageSize;

    function showPagerList() {
      const totalPage = Math.ceil(paginationData.total / paginationData.pageSize);
      pagerContainer.innerHTML = "";
      const createLi = (i) => {
        const li = document.createElement("li");
        li.innerText = i;
        pagerContainer.appendChild(li);
        // add click event
        if (i !== "...") {
          li.addEventListener("click", () => {
            paginationData.currentPage = i;
            changePage();
          });
        }
        // set active
        if (i === paginationData.currentPage) {
          li.classList.add("active");
        }
      }
      const start = 1, end = totalPage;
      const pagerNumberList = [];
      if (paginationData.currentPage - start > 3) {
        pagerNumberList.push(...[start, start + 1, "...", paginationData.currentPage - 1, paginationData.currentPage]);
      } else {
        for (let i = start; i <= paginationData.currentPage; i++) {
          pagerNumberList.push(i);
        }
      }
      if (end - paginationData.currentPage > 3) {
        pagerNumberList.push(...[paginationData.currentPage + 1, "...", end - 1, end]);
      } else {
        for (let i = paginationData.currentPage + 1; i <= end; i++) {
          pagerNumberList.push(i);
        }
      }
      pagerNumberList.forEach((item) => {
        createLi(item);
      });
    }

    function changeTotal() {
      pageItems.length = 0;
      for (let i = 0; i < contentContainer.children.length; i++) {
        if (contentContainer.children[i].classList.contains("my-pagination") || contentContainer.children[i].tagName === "SCRIPT") {
          continue;
        }
        pageItems.push(contentContainer.children[i]);
      }
      paginationData.total = pageItems.length;
      totalContainer.innerText = `共 ${paginationData.total} 条`;
    }

    function changeContentShow() {
      const showPageStart = paginationData.pageSize * (paginationData.currentPage - 1);
      const showPageEnd = paginationData.pageSize * paginationData.currentPage;
      for (let i = 0; i < paginationData.total; i++) {
        if (i >= showPageStart && i < showPageEnd) {
          pageItems[i].classList.remove("hide");
        } else {
          pageItems[i].classList.add("hide");
        }
      }
    }

    function changePage() {
      showPagerList();
      changeContentShow();
      gotoInput.value = paginationData.currentPage;
    }

    function startPagination() {
      changeTotal();
      changePage();
    }

    sizesSelect.addEventListener("change", (e) => {
      paginationData.pageSize = e.target.value;
      paginationData.currentPage = 1;
      changePage();
    });

    gotoInput.addEventListener("keyup", (e) => {
      if (e.keyCode === 13) {
        const gotoPage = parseInt(e.target.value);
        if (gotoPage > 0 && gotoPage <= Math.ceil(paginationData.total / paginationData.pageSize)) {
          paginationData.currentPage = gotoPage;
          changePage();
        }
      }
    });

    // 监听内容变化
    const observer = new MutationObserver((mutationsList) => {
      for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
          changeTotal();
          paginationData.currentPage = 1;
          changePage();
        }
      }
    });
    observer.observe(contentContainer, { childList: true });

    startPagination();
  })();
</script>
      </div>
    </div>
  </div>
</div>


  <div class="content">
    <div class="container">
      <div class="row main-container">

        
          <div class="col-md-2 col-lg-2 hidden-xs hidden-sm left-side fadein-left">
            
<div class="toc-container">
  <div class="toc-header">
    <h3>目录导航</h3>
  </div>
  <ul id="toc-list"></ul>
</div>

          </div>
          <div class="my-col col-xs-12 col-sm-12 col-md-8 col-lg-8 fadein-right">
            <div class="page-content box-shadow"><div class="post">

  <header class="post-header">
    <h1 class="post-title">vue自定义组件 search-box</h1>
    <div class="info">
      <p class="post-meta">
        <i class="fa fa-calendar"></i>
        &nbsp;
        2023-05-17 05:15
        
        
      </p>
      
      <span class="post-classify-list">
        <i class="fa fa-folder-open"></i>
        
        <a class="category" data-tag="开发日志">开发日志</a>
        
      </span>
      &nbsp;
      
      
      <span class="post-tag-list">
        <i class="fa fa-tags"></i>
        <span class="index-post-tag">
          
          <a data-tag="前端">前端</a>
          
          <a data-tag="vue">vue</a>
          
        </span>
      </span>
      
    </div>
  </header>

  <article class="post-content">
    <p>本文首次发布于博客园：<a href="https://www.cnblogs.com/lxm-cnblog/p/17408456.html">https://www.cnblogs.com/lxm-cnblog/p/17408456.html</a>
现在转移到 github pages 上。</p>

<p>github地址: <a href="https://github.com/lxmghct/my-vue-components">https://github.com/lxmghct/my-vue-components</a></p>

<h2 id="组件介绍">组件介绍</h2>
<ul>
  <li>props:
    <ul>
      <li>value/v-model: 检索框的值, default: ‘’</li>
      <li>boxStyle: 检索框的样式, default: ‘position: fixed; top: 0px; right: 100px;’</li>
      <li>highlightColor: 高亮颜色, default: ‘rgb(246, 186, 130)’</li>
      <li>currentColor: 当前高亮颜色, default: ‘rgb(246, 137, 31)’</li>
      <li>selectorList: 检索的选择器列表, default: []</li>
      <li>iFrameId: 检索的iframe的id, default: null, 若需要搜索iframe标签中的内容, 则将该参数设为目标iframe的id</li>
      <li>beforeJump: 跳转前的回调函数, default: () =&gt; {}</li>
      <li>afterJump: 跳转后的回调函数, default: () =&gt; {}</li>
      <li>(注: 上述两个回调函数参数为currentIndex, currentSelector, lastIndex, lastSelector)</li>
    </ul>
  </li>
  <li>events:
    <ul>
      <li>@search: 检索时触发, 参数为input和total</li>
      <li>@goto: 跳转时触发, 参数为index</li>
      <li>@close: 关闭时触发</li>
    </ul>
  </li>
  <li>methods:
    <ul>
      <li>clear() 清空检索框</li>
      <li>search() 检索</li>
    </ul>
  </li>
</ul>

<h2 id="效果展示">效果展示</h2>
<p><img src="/post_assets/images/2023/05/17-vue-search-box.gif" alt="" /></p>

<h2 id="设计思路">设计思路</h2>
<p>完整代码见github: <a href="https://github.com/lxmghct/my-vue-components">https://github.com/lxmghct/my-vue-components</a>
在其中的src/components/SearchBox下。</p>
<h3 id="1-界面">1. 界面</h3>
<p>界面上比较简单, 输入框、当前/总数、上一个、下一个、关闭按钮。</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"search-box"</span> <span class="na">:style=</span><span class="s">"boxStyle"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span>
    <span class="na">v-model=</span><span class="s">"input"</span>
    <span class="na">placeholder=</span><span class="s">"请输入检索内容"</span>
    <span class="na">class=</span><span class="s">"search-input"</span>
    <span class="na">type=</span><span class="s">"text"</span>
    <span class="err">@</span><span class="na">input=</span><span class="s">"search"</span>
  <span class="nt">&gt;</span>
  <span class="c">&lt;!--当前/总数、上一个、下一个、关闭--&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"input-append"</span><span class="nt">&gt;</span>
    <span class="ni">&amp;nbsp;&amp;nbsp;</span>/<span class="ni">&amp;nbsp;&amp;nbsp;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"input-append"</span> <span class="err">@</span><span class="na">click=</span><span class="s">"searchPrevious"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"svg-container"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">"100px"</span> <span class="na">height=</span><span class="s">"100px"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"M 100 0 L 0 50 L 100 100"</span> <span class="na">stroke=</span><span class="s">"black"</span> <span class="na">fill=</span><span class="s">"transparent"</span> <span class="na">stroke-linecap=</span><span class="s">"round"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/svg&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"input-append"</span> <span class="err">@</span><span class="na">click=</span><span class="s">"searchNext"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"svg-container"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">"100px"</span> <span class="na">height=</span><span class="s">"100px"</span> <span class="na">transform=</span><span class="s">"rotate(180)"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;path</span> <span class="na">d=</span><span class="s">"M 100 0 L 0 50 L 100 100"</span> <span class="na">stroke=</span><span class="s">"black"</span> <span class="na">fill=</span><span class="s">"transparent"</span> <span class="na">stroke-linecap=</span><span class="s">"round"</span><span class="nt">/&gt;</span>
      <span class="nt">&lt;/svg&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"input-append"</span> <span class="err">@</span><span class="na">click=</span><span class="s">"searchClose"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"svg-container"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;svg</span> <span class="na">width=</span><span class="s">"100%"</span> <span class="na">height=</span><span class="s">"100%"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;line</span> <span class="na">x1=</span><span class="s">"0"</span> <span class="na">y1=</span><span class="s">"0"</span> <span class="na">x2=</span><span class="s">"100%"</span> <span class="na">y2=</span><span class="s">"100%"</span> <span class="na">stroke=</span><span class="s">"black"</span> <span class="na">stroke-width=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;line</span> <span class="na">x1=</span><span class="s">"100%"</span> <span class="na">y1=</span><span class="s">"0"</span> <span class="na">x2=</span><span class="s">"0"</span> <span class="na">y2=</span><span class="s">"100%"</span> <span class="na">stroke=</span><span class="s">"black"</span> <span class="na">stroke-width=</span><span class="s">"1"</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/svg&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/span&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<h3 id="2-检索与跳转">2. 检索与跳转</h3>
<p>这部分是search-box的核心功能，一共有以下几个需要解决的问题:</p>
<ol>
  <li>获取待搜索的容器
    <ul>
      <li>为提高组件的通用性，可以通过传入选择器列表来获取容器，如<code class="language-plaintext highlighter-rouge">['.container', '#containerId']</code>，使用<code class="language-plaintext highlighter-rouge">document.querySelector()</code>获取容器。</li>
    </ul>
  </li>
  <li>获取所有文本
    <ul>
      <li>不能单独对某个dom节点获取文本, 因为某个待搜索词可能被分割在多个节点中, 例如<code class="language-plaintext highlighter-rouge">&lt;span&gt;hello&lt;/span&gt;&lt;span&gt;world&lt;/span&gt;</code>，所以需要获取整个容器内的所有文本拼接起来, 然后再进行检索。</li>
      <li>使用<code class="language-plaintext highlighter-rouge">innetText</code>获取文本会受到样式影响, 具体见文章最后的其它问题。所以需要遍历所有节点将文本拼接起来。</li>
      <li>遍历文本节点时, 可以用<code class="language-plaintext highlighter-rouge">node.nodeType === Node.TEXT_NODE</code>判断是否为文本节点。
        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="k">if </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">TEXT_NODE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// text node</span>
  <span class="nf">callback</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
 <span class="p">}</span> <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">nodeType</span> <span class="o">===</span> <span class="nx">Node</span><span class="p">.</span><span class="nx">ELEMENT_NODE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// element node</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nf">traverseTextDom</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">callback</span><span class="p">)</span>
  <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>检索结果的保存
    <ul>
      <li>由于查找完之后需要实现跳转, 所以为方便处理, 将检索到的结果所在的dom节点保存起来, 以便后续跳转时使用。每个结果对应一个domList。</li>
    </ul>
  </li>
  <li>高亮检索词
    <ul>
      <li>使用span标签包裹检索词, 并设置样式, 实现高亮。</li>
      <li>为了避免检索词被html标签分割, 可以对检索词的每个字符都用span标签包裹, 例如检索词为<code class="language-plaintext highlighter-rouge">hello</code>，则可以将其替换为<code class="language-plaintext highlighter-rouge">&lt;span&gt;h&lt;/span&gt;&lt;span&gt;e&lt;/span&gt;&lt;span&gt;l&lt;/span&gt;&lt;span&gt;l&lt;/span&gt;&lt;span&gt;o&lt;/span&gt;</code>。</li>
      <li>样式设置可以给span设置background-color, 为了方便修改并减小整体html长度, 可以改为给span设置class, 注意这种情况下在style标签设置的样式未必有效, 可以采用动态添加样式的方式。
        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">function</span> <span class="nf">createCssStyle</span> <span class="p">(</span><span class="nx">css</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">style</span> <span class="o">=</span> <span class="nx">myDocument</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">)</span>
  <span class="nx">style</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">text/css</span><span class="dl">'</span>
  <span class="k">try</span> <span class="p">{</span>
      <span class="nx">style</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">myDocument</span><span class="p">.</span><span class="nf">createTextNode</span><span class="p">(</span><span class="nx">css</span><span class="p">))</span>
  <span class="p">}</span> <span class="k">catch </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">style</span><span class="p">.</span><span class="nx">styleSheet</span><span class="p">.</span><span class="nx">cssText</span> <span class="o">=</span> <span class="nx">css</span>
  <span class="p">}</span>
  <span class="nx">myDocument</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">'</span><span class="s1">head</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span>
 <span class="p">}</span>
</code></pre></div>        </div>
      </li>
      <li>将span标签插入到原先文本节点的位置, 若使用innerHtml直接进行替换, 处理起来略有些麻烦。可以考虑使用insertBefore和removeChild方法。
        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">const</span> <span class="nx">tempNode</span> <span class="o">=</span> <span class="nx">myDocument</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">span</span><span class="dl">'</span><span class="p">)</span>
 <span class="nx">tempNode</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">textHtml</span>
 <span class="kd">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">tempNode</span><span class="p">.</span><span class="nx">children</span>
 <span class="k">if </span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
<span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">domList</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span>
<span class="p">}</span>
 <span class="p">}</span>
 <span class="c1">// 将节点插入到parent的指定位置</span>
 <span class="c1">// insertBofore会将节点从原来的位置移除，导致引错误，所以不能用forEach</span>
 <span class="k">while </span><span class="p">(</span><span class="nx">tempNode</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">)</span> <span class="p">{</span>
<span class="nx">parent</span><span class="p">.</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">tempNode</span><span class="p">.</span><span class="nx">firstChild</span><span class="p">,</span> <span class="nx">textNode</span><span class="p">)</span>
 <span class="p">}</span>
 <span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">textNode</span><span class="p">)</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>跳转
 由于结果对应的dom节点已保存，所以跳转起来比较容易。跳转时修改当前高亮的dom节点的类名, 然后将其滚动到可视区域。
    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nf">setCurrent </span><span class="p">(</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">const</span> <span class="nx">lastSelector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">]</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">].</span><span class="nx">selector</span> <span class="p">:</span> <span class="kc">null</span>
     <span class="kd">const</span> <span class="nx">currentSelector</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="nx">index</span><span class="p">].</span><span class="nx">selector</span> <span class="p">:</span> <span class="kc">null</span>
     <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">].</span><span class="nx">domList</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">dom</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
             <span class="nx">dom</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentClass</span><span class="p">)</span>
         <span class="p">})</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">].</span><span class="nx">domList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">scrollIntoView</span><span class="p">({</span> <span class="na">behavior</span><span class="p">:</span> <span class="dl">'</span><span class="s1">smooth</span><span class="dl">'</span><span class="p">,</span> <span class="na">block</span><span class="p">:</span> <span class="dl">'</span><span class="s1">center</span><span class="dl">'</span> <span class="p">})</span>
     <span class="p">}</span>
     <span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">index</span>
     <span class="k">if </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">this</span><span class="p">.</span><span class="nx">searchResult</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">currentIndex</span><span class="p">].</span><span class="nx">domList</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">dom</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
             <span class="nx">dom</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">currentClass</span><span class="p">)</span>
         <span class="p">})</span>
     <span class="p">}</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>移除高亮效果
    <ul>
      <li>由于高亮效果是通过给text节点添加span标签实现, 所以需要将span标签移除, 并替换为原先的文本节点。</li>
      <li>使用<code class="language-plaintext highlighter-rouge">insertBefore</code>和<code class="language-plaintext highlighter-rouge">removeChild</code>方法。</li>
      <li>替换完节点后需要调用<code class="language-plaintext highlighter-rouge">normalize()</code>方法, 将相邻的文本节点合并为一个文本节点。
        <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kd">function</span> <span class="nf">convertHighlightDomToTextNode</span> <span class="p">(</span><span class="nx">domList</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">domList</span> <span class="o">||</span> <span class="o">!</span><span class="nx">domList</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
  <span class="nx">domList</span><span class="p">.</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">dom</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">dom</span> <span class="o">&amp;&amp;</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">dom</span><span class="p">.</span><span class="nx">parentNode</span>
          <span class="kd">const</span> <span class="nx">textNode</span> <span class="o">=</span> <span class="nx">myDocument</span><span class="p">.</span><span class="nf">createTextNode</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">textContent</span><span class="p">)</span>
          <span class="nx">parent</span><span class="p">.</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">textNode</span><span class="p">,</span> <span class="nx">dom</span><span class="p">)</span>
          <span class="nx">parent</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">dom</span><span class="p">)</span>
          <span class="nx">parent</span><span class="p">.</span><span class="nf">normalize</span><span class="p">()</span> <span class="c1">// 合并相邻的文本节点</span>
      <span class="p">}</span>
  <span class="p">})</span>
 <span class="p">}</span>
</code></pre></div>        </div>
      </li>
    </ul>
  </li>
</ol>

<h3 id="3-添加对iframe的支持">3. 添加对iframe的支持</h3>
<p>有时候页面中可能会包含iframe标签, 如果需要检索iframe中的内容, 直接使用当前的document是无法获取到iframe中的内容的, 需要拿到iframe的document对象。</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">myIframe</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">iframeId</span><span class="p">)</span>
<span class="k">if </span><span class="p">(</span><span class="nx">myIframe</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">myDocument</span> <span class="o">=</span> <span class="nx">myIframe</span><span class="p">.</span><span class="nx">contentDocument</span> <span class="o">||</span> <span class="nx">myIframe</span><span class="p">.</span><span class="nx">contentWindow</span><span class="p">.</span><span class="nb">document</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="nx">myDocument</span> <span class="o">=</span> <span class="nb">document</span>
<span class="p">}</span>
<span class="k">if </span><span class="p">(</span><span class="nx">myIframe</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lastIframeSrc</span> <span class="o">!==</span> <span class="nx">myIframesrc</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">css</span> <span class="o">=</span> <span class="s2">`.</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">highlightClass</span><span class="p">}</span><span class="s2"> { background-color: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">highlightColor</span><span class="p">}</span><span class="s2">; } .</span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">currentClass</span><span class="p">}</span><span class="s2"> { background-color: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">currentColor</span><span class="p">}</span><span class="s2">; }`</span>
  <span class="nf">createCssStyle</span><span class="p">(</span><span class="nx">css</span><span class="p">)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">lastIframeSrc</span> <span class="o">=</span> <span class="nx">myIframe</span><span class="p">.</span><span class="nx">src</span>
<span class="p">}</span>
</code></pre></div></div>
<p>同一个iframe, 如果src发生变化, 则需要重新给其生成样式, 否则样式会失效。</p>
<h2 id="其他问题">其他问题</h2>
<ol>
  <li>使用svg画按钮图标时，双击svg按钮会自动触发全选
    <ul>
      <li>解决方法: 在svg标签所在容器上添加<code class="language-plaintext highlighter-rouge">user-select: none;</code>样式</li>
    </ul>
  </li>
  <li>使用<code class="language-plaintext highlighter-rouge">node.nodeType === Node.TEXT_NODE</code>判断文本节点时，会遇到一些空节点，导致检索错误
    <ul>
      <li>解决方法: 在判断文本节点时，加上<code class="language-plaintext highlighter-rouge">node.textContent.trim() !== ''</code>的判断, 获取所有元素的文本时。</li>
      <li>后续修改: 可以不单独处理这些空的文本节点, 只要保证所有使用到获取文本的地方都统一使用或不使用<code class="language-plaintext highlighter-rouge">trim()</code>即可。尽量都不使用<code class="language-plaintext highlighter-rouge">trim()</code>, 如果随意使用<code class="language-plaintext highlighter-rouge">trim()</code>，可能会导致部分空白字符被误删。</li>
    </ul>
  </li>
</ol>

  </article>
</div>

<div class="prev-and-next">
  
  <div>
    <span>上一篇 ：</span><a href="/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/2023/05/25/windows%E4%B8%8B%E5%B0%86Pikafish%E7%BC%96%E8%AF%91%E4%B8%BA%E5%AE%89%E5%8D%93%E5%8F%AF%E6%89%A7%E8%A1%8C%E6%96%87%E4%BB%B6.html" title="windows下将Pikafish编译为安卓可执行文件">windows下将Pikafish编译为安卓可执行文件</a>
  </div>
  
  
  <div>
    <span>下一篇 ：</span><a href="/%E6%8A%80%E6%9C%AF%E6%8E%A2%E7%B4%A2/2023/05/09/Mybatis-plus%E6%8B%A6%E6%88%AA%E5%99%A8%E8%A7%A3%E5%86%B3foreach%E5%88%97%E8%A1%A8%E4%B8%BA%E7%A9%BA%E6%8A%A5%E9%94%99%E9%97%AE%E9%A2%98.html"
      title="Mybatis plus拦截器解决 foreach 列表为空报错问题">Mybatis plus拦截器解决 foreach 列表为空报错问题</a>
  </div>
  
  <div>
    <span> 版权所有，转载时必须以链接形式注明原始出处</span>
  </div>

</div>

<script>
    // 点击<a>跳转到/pages/tags.html#
    document.querySelectorAll(".index-post-tag a").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/tags.html#" + item.getAttribute("data-tag");
        });
    });
    document.querySelectorAll(".post-header a.category").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/classify.html#" + item.getAttribute("data-tag");
        });
    });

    // 生成目录
    // 获取文章内容的标题
    const headings = document.querySelectorAll(".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6");
    if (headings.length === 0) {
        document.querySelector(".toc-container").classList.add("hidden");
    } else {
        document.querySelector(".toc-container").classList.remove("hidden");
    }
    // 目录容器
    const tocList = document.getElementById("toc-list");
    const tempTocData = []

    // 遍历标题，生成目录
    headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1), 10); // 获取标题级别
        const listItem = document.createElement("li");
        const link = document.createElement("a");

        link.textContent = heading.textContent;
        if (!heading.id) {
            heading.id = heading.textContent.replace(/\s+/g, "-").toLowerCase();
        }
        link.href = `#${heading.id}`;
        listItem.appendChild(link);
        tocList.appendChild(listItem);
        tempTocData.push({
            level: level,
            dom: listItem
        })
    });

    // 设置目录项的左边距
    const minLevel = Math.min(...tempTocData.map(item => item.level))
    tempTocData.forEach(item => {
        let diff = item.level - minLevel
        item.dom.style.marginLeft = diff * 20 + "px"
        if (diff === 0) {
            item.dom.classList.add("root-toc")
        }
    })

</script>

<script type="text/javascript" src="/assets/js/highlight/highlight.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/highlightjs-line-numbers.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/run-highlight.js"></script>

<!-- beaudar评论, 日期+标题作为issue名 -->
<script src="https://beaudar.lipk.org/client.js"
  repo="lxmghct/blog-comments"
  branch="master"
  issue-term="【2023-05-17】 vue自定义组件 search-box"
  theme="github-light"
  loading="false"
  crossorigin="anonymous" async>
</script></div>
          </div>
        


      </div>
    </div>
  </div>

  <div id="back-to-top">
    <a href="#"><i class="fa fa-arrow-circle-up"></i></a>
  </div>

  <footer class="site-footer">

  <div class="footer-col-wrapper">
    <div class="footer-col  footer-col-1">
      <ul class="contact-list">
        <li>lxmghct's blog</li>
        <li><a href="mailto:lxmghct@gmail.com">lxmghct@gmail.com</a></li>
        <li></li>
      </ul>
    </div>

    <div class="footer-col  footer-col-2">
      <div class="social-media-list">
        
        <a class="github" href="https://github.com/lxmghct" target="_blank" title="github"></a>
        
        
        <a class="rss" href="/feed.xml" target="_blank" title="rss"></a>
        
      </div>
    </div>

    <div class="footer-col  footer-col-3">
      <p class="text">学习、实践、分享<br> Learning, Practicing, Sharing</p>
    </div>
  </div>
  <div class="center sitedesc">
    Powered by <a href="http://jekyllrb.com/">Jekyll</a> | Hosted on <a href="https://pages.github.com/">
      Github</a>
  </div>

  <script type="text/javascript" src="/assets/js/jquery.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.js"></script>
  <script type="text/javascript" src="/assets/js/tagutils.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
  <script type="text/javascript" type="module" src="/assets/js/search.js"></script>

</footer>

</body>

</html>