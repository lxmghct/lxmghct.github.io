<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>jekyll使用highlight.js对代码块进行高亮 | lxmghct's blog</title>
  <meta name="description"
    content="我想给自己的博客添加代码块自动高亮的功能，使用功能强大的highlight.js是一个不错的选择。整体来说，我想完成以下几个功能：  代码块自动高亮，能够根据代码块中的语言类别进行高亮。  代码块中的行号显示。  添加一些额外功能，如复制代码、切换自动换行等。">


  <link rel="stylesheet" href=" /assets/css/bootstrap.css">
  <link rel="stylesheet" href=" /assets/css/font-awesome.css">
  <link rel="stylesheet" href=" /assets/css/main.css">
  <link rel="stylesheet" href=" /assets/css/layouts/default.css">
  <link rel="stylesheet" href=" /assets/css/highlight/default.min.css">
  <link rel="stylesheet" href=" /assets/css/includes/header.css">
  <link rel="stylesheet" href=" /assets/css/includes/footer.css">
  <link rel="stylesheet" href=" /assets/css/includes/search.css">
  <link rel="stylesheet" href=" /assets/css/includes/pagination.css">
  <link rel="stylesheet" href=" /assets/css/layouts/post.css">
  <link rel="stylesheet" href=" /assets/css/highlight/post-highlight.css">
  <link rel="stylesheet" href=" /assets/css/pages/index.css">
  <link rel="shortcut icon" href="" />
  <link rel="canonical" href="/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/2023/10/15/jekyll%E4%BD%BF%E7%94%A8highlight.js%E5%AF%B9%E4%BB%A3%E7%A0%81%E5%9D%97%E8%BF%9B%E8%A1%8C%E9%AB%98%E4%BA%AE.html">
  <link rel="alternate" type="application/rss+xml" title="lxmghct's blog" href=" /feed.xml" />
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>


<body>

  <div class="site-header">
	<div class="container">
		<div class="row">
			<div class="navbar navbar-default" role="navigation">

				<div class="navbar-header col-xs-8 col-sm-8 col-md-3 col-lg-3 center">
					<div class="header-title">
						<a href="/" title="首页"></a>
						<i class="fa fa-home fa-2x"></i>
						<a class="site-title" href="/">lxmghct's blog</a>
					</div>
				</div>

				<div class="col-md-6 col-lg-6 hidden-sm hidden-xs center">
					<div class="site-nav">
						<ul class="nav nav-pills">
							<li class="select"><a class="page-link" href="/pages/classify.html">分类</a></li>
							<li class="select"><a class="page-link" href="/pages/archive.html">归档</a></li>
							<li class="select"><a class="page-link" href="/pages/tags.html">标签</a></li>
							<li class="select"><a class="page-link" href="/pages/about.html">关于</a></li>
						</ul>
					</div>
				</div>

				<div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
					<div id="header-search" class="search-input-container">
						<input id="header-search-input" type="text" class="header-search-input" placeholder="Search">
						<!--搜索图标-->
						<i class="fa fa-search fa-lg search-icon"></i>
					</div>
				</div>

				<!-- 宽度不够时显示 -->
				<div class="hidden-lg hidden-md col-sm-4 col-xs-4">
					<div class="header-hidden-buttons">
						<i class="fa fa-search fa-lg search-icon"></i>
						<i class="fa fa-bars fa-2x menu-icon"></i>
						<!-- 用于控制菜单的显示和隐藏 -->
						<input type="checkbox" id="nav-trigger" class="nav-trigger">
					</div>
				</div>

				<div class="phone-nav">
					<ul>
						<li><a href="/">首 页</a></li>
						<li><a href="/pages/classify.html">分 类</a></li>
						<li><a href="/pages/archive.html">归 档</a></li>
						<li><a href="/pages/tags.html">标 签</a></li>
						<li><a href="/pages/about.html">关 于</a></li>
					</ul>
				</div>

			</div>
		</div>
	</div>
</div>

<!--遮罩层-->
<div class="search-mask"></div>
<div class="search-container">
  <!-- 右上角关闭按钮 -->
  <i class="fa fa-times fa-2x search-container-close"></i>
  <div class="search-container-main">
    <div class="search-container-wrapper">
      <div class="search-input-container">
        <input type="text" class="search-input" placeholder="Search">
        <!--搜索图标-->
        <i class="fa fa-search fa-lg search-icon search-start"></i>
        <!--关闭图标-->
        <i class="fa fa-times fa-lg search-icon search-clear"></i>
      </div>
      <div class="search-filter">
        <!--只查找标题选择框-->
        <input type="checkbox" class="search-filter-input">
        <span class="search-filter-text">只查找标题</span>
      </div>
      <div class="search-result-summary"></div>
      <div class="search-result-container">
      </div>
      <div class="search-pagination">
        <!-- pagination.html -->

<div class="my-pagination">
  <ul class="my-pager">
    <li class="active">1</li>
    <li>2</li>
  </ul>
  <span class="my-pagination__sizes">
    <span class="my-pagination__sizes__label">每页</span>
    <select class="my-pagination__sizes__select" autocomplete="off">
      <option>5</option>
      <option>10</option>
      <option>20</option>
    </select>
    <span class="my-pagination__sizes__label">条</span>
  </span>
  <span class="my-pagination__total">共 0 条</span>
  <span class="my-pagination__goto">
    <span class="my-pagination__goto__label">前往</span>
    <input class="my-pagination__goto__input" type="text" />
    <span class="my-pagination__goto__label">页</span>
  </span>
</div>

<script>
  (function () {
    const contentSelector = '.search-result-container';
    const parentSelector = '.search-pagination';
    const contentContainer = document.querySelector(`${contentSelector}`);
    if (!contentContainer || !contentSelector || !parentSelector) {
      console.error("pagination.html: content or parent is not defined");
      return;
    }
    const pageItems = []
    const pagerContainer = document.querySelector(`${parentSelector} .my-pager`);
    const totalContainer = document.querySelector(`${parentSelector} .my-pagination__total`);
    const sizesSelect = document.querySelector(`${parentSelector} .my-pagination__sizes__select`);
    const gotoInput = document.querySelector(`${parentSelector} .my-pagination__goto__input`);

    const paginationData = {
      total: 0,
      pageSize: 10,
      currentPage: 1
    }
    sizesSelect.value = paginationData.pageSize;

    function showPagerList() {
      const totalPage = Math.ceil(paginationData.total / paginationData.pageSize);
      pagerContainer.innerHTML = "";
      const createLi = (i) => {
        const li = document.createElement("li");
        li.innerText = i;
        pagerContainer.appendChild(li);
        // add click event
        if (i !== "...") {
          li.addEventListener("click", () => {
            paginationData.currentPage = i;
            changePage();
          });
        }
        // set active
        if (i === paginationData.currentPage) {
          li.classList.add("active");
        }
      }
      const start = 1, end = totalPage;
      const pagerNumberList = [];
      if (paginationData.currentPage - start > 3) {
        pagerNumberList.push(...[start, start + 1, "...", paginationData.currentPage - 1, paginationData.currentPage]);
      } else {
        for (let i = start; i <= paginationData.currentPage; i++) {
          pagerNumberList.push(i);
        }
      }
      if (end - paginationData.currentPage > 3) {
        pagerNumberList.push(...[paginationData.currentPage + 1, "...", end - 1, end]);
      } else {
        for (let i = paginationData.currentPage + 1; i <= end; i++) {
          pagerNumberList.push(i);
        }
      }
      pagerNumberList.forEach((item) => {
        createLi(item);
      });
    }

    function changeTotal() {
      pageItems.length = 0;
      for (let i = 0; i < contentContainer.children.length; i++) {
        if (contentContainer.children[i].classList.contains("my-pagination") || contentContainer.children[i].tagName === "SCRIPT") {
          continue;
        }
        pageItems.push(contentContainer.children[i]);
      }
      paginationData.total = pageItems.length;
      totalContainer.innerText = `共 ${paginationData.total} 条`;
    }

    function changeContentShow() {
      const showPageStart = paginationData.pageSize * (paginationData.currentPage - 1);
      const showPageEnd = paginationData.pageSize * paginationData.currentPage;
      for (let i = 0; i < paginationData.total; i++) {
        if (i >= showPageStart && i < showPageEnd) {
          pageItems[i].classList.remove("hide");
        } else {
          pageItems[i].classList.add("hide");
        }
      }
    }

    function changePage() {
      showPagerList();
      changeContentShow();
      gotoInput.value = paginationData.currentPage;
    }

    function startPagination() {
      changeTotal();
      changePage();
    }

    sizesSelect.addEventListener("change", (e) => {
      paginationData.pageSize = e.target.value;
      paginationData.currentPage = 1;
      changePage();
    });

    gotoInput.addEventListener("keyup", (e) => {
      if (e.keyCode === 13) {
        const gotoPage = parseInt(e.target.value);
        if (gotoPage > 0 && gotoPage <= Math.ceil(paginationData.total / paginationData.pageSize)) {
          paginationData.currentPage = gotoPage;
          changePage();
        }
      }
    });

    // 监听内容变化
    const observer = new MutationObserver((mutationsList) => {
      for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
          changeTotal();
          paginationData.currentPage = 1;
          changePage();
        }
      }
    });
    observer.observe(contentContainer, { childList: true });

    startPagination();
  })();
</script>
      </div>
    </div>
  </div>
</div>


  <div class="content">
    <div class="container">
      <div class="row main-container">

        
          <div class="col-md-2 col-lg-2 hidden-xs hidden-sm left-side fadein-left">
            
<div class="toc-container">
  <div class="toc-header">
    <h3>目录导航</h3>
  </div>
  <ul id="toc-list"></ul>
</div>

          </div>
          <div class="my-col col-xs-12 col-sm-12 col-md-8 col-lg-8 fadein-right">
            <div class="page-content box-shadow"><div class="post">

  <header class="post-header">
    <h1 class="post-title">jekyll使用highlight.js对代码块进行高亮</h1>
    <div class="info">
      <p class="post-meta">
        <i class="fa fa-calendar"></i>
        &nbsp;
        2023-10-15 13:20
        
        
      </p>
      
      <span class="post-classify-list">
        <i class="fa fa-folder-open"></i>
        
        <a class="category" data-tag="开发日志">开发日志</a>
        
      </span>
      &nbsp;
      
      
      <span class="post-tag-list">
        <i class="fa fa-tags"></i>
        <span class="index-post-tag">
          
          <a data-tag="jekyll">jekyll</a>
          
          <a data-tag="前端">前端</a>
          
        </span>
      </span>
      
    </div>
  </header>

  <article class="post-content">
    <p>我想给自己的博客添加代码块自动高亮的功能，使用功能强大的highlight.js是一个不错的选择。整体来说，我想完成以下几个功能：</p>
<ol>
  <li>代码块自动高亮，能够根据代码块中的语言类别进行高亮。</li>
  <li>代码块中的行号显示。</li>
  <li>添加一些额外功能，如复制代码、切换自动换行等。</li>
</ol>

<p>highlight.js官网: <a href="https://highlightjs.org/">https://highlightjs.org/</a><br />
highlight.js中文文档: <a href="http://highlight.cndoc.wiki/doc/">http://highlight.cndoc.wiki/doc/</a></p>

<h2 id="1-highlightjs简介">1. highlight.js简介</h2>
<p>highlight.js 是一个用 JavaScript 编写的语法高亮库。它可以用来美化网页中的代码块，使其在浏览器中呈现出更具可读性的样式。highlight.js 支持超过 180 种编程语言和格式，包括常见的语言如 JavaScript、Python、Java，以及各种配置文件、标记语言等。</p>

<p>highlight.js 的主要特点包括：</p>
<ul>
  <li>轻量级：highlight.js 是一个轻量级的库，易于集成到网页中，并且不依赖于其他库或框架。</li>
  <li>易用性：只需简单的几行代码，就可以在网页中集成代码高亮功能。</li>
  <li>多语言支持：支持超过 180 种编程语言和格式的语法高亮。</li>
  <li>自动检测：highlight.js 可以自动检测代码块中的语言类型，无需手动指定。</li>
  <li>可定制性：用户可以根据需要自定义代码块的样式和主题。</li>
</ul>

<h3 id="11-使用highlightjs">1.1 使用highlight.js</h3>
<p>去官网<a href="https://highlightjs.org/download">https://highlightjs.org/download</a>下载 highlight.js，可以选择自己需要的语言，也可以直接使用默认的 highlight.js。下载后得到压缩包 highlight.zip，如果只使用默认样式，则只需要将<code class="language-plaintext highlighter-rouge">highlight.min.js</code>和<code class="language-plaintext highlighter-rouge">default.min.css</code>放到项目中即可。</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/path/to/styles/default.min.css"</span><span class="nt">&gt;</span>
<span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/path/to/highlight.min.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nx">hljs</span><span class="p">.</span><span class="nf">highlightAll</span><span class="p">();</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>
<p>上面代码是最简单的使用方式，调用<code class="language-plaintext highlighter-rouge">hljs.highlightAll()</code>会自动对页面中所有<code class="language-plaintext highlighter-rouge">&lt;pre&gt;&lt;code&gt;</code>标签自动识别语言并进行高亮。如果需要指定语言，可以在<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签中添加<code class="language-plaintext highlighter-rouge">class</code>属性，如<code class="language-plaintext highlighter-rouge">&lt;code class="language-javascript"&gt;</code>。</p>

<h2 id="2-在jekyll中使用highlightjs的过程以及遇到的问题">2. 在jekyll中使用highlight.js的过程以及遇到的问题</h2>
<h3 id="21-jekyll中的代码块">2.1 jekyll中的代码块</h3>
<p>首先要弄清楚 jekyll 是如何渲染代码块的。我使用了两段代码来做测试：
首先用了一段 python 代码作为例子：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hello world</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>检查渲染后的 html 代码，可以看到如下图所示的结构：
<img src="/post_assets/images/2023/10/16-raw-structrue-1.png" alt="jekyll代码块渲染后的html结构" />
然后用了同样的代码，但是随便改了个语言类别为 test1：</p>
<pre><code class="language-test1">print("hello world")
</code></pre>
<p>检查渲染后的 html 代码，可以看到如下图所示的结构：
<img src="/post_assets/images/2023/10/16-raw-structrue-2.png" alt="jekyll代码块渲染后的html结构" /></p>

<p><img src="image.png" alt="Alt text" /></p>

<p>可以看到，jekyll 渲染代码块的时候，对于可以识别的代码类型，会将代码块包裹在<code class="language-plaintext highlighter-rouge">&lt;div class="highlighter-rouge"&gt;</code>中，其中包含了<code class="language-plaintext highlighter-rouge">language-python</code>类名，然后在其中依次添加类名为<code class="language-plaintext highlighter-rouge">highlight</code>的<code class="language-plaintext highlighter-rouge">&lt;div&gt;</code>和<code class="language-plaintext highlighter-rouge">&lt;pre&gt;</code>标签，然后添加一个没有任何类的<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签。对于无法识别的代码类型，则直接生成一个<code class="language-plaintext highlighter-rouge">&lt;pre&gt;</code>标签，然后在其中添加一个类名为<code class="language-plaintext highlighter-rouge">language-xxx</code>的<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签。如果未指定语言，则视为第一种情况，语言类型为<code class="language-plaintext highlighter-rouge">plaintext</code>。</p>

<p>为了方便后续统一处理，主要是后续添加行号以及方便后面样式上的统一修改，我采用的方法是把情况二转化成情况一的结构，也就是从<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签中提取语言类别，然后外层添加<code class="language-plaintext highlighter-rouge">&lt;div class="highlighter-rouge"&gt;</code>。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 找到没有任何类的&lt;pre&gt;元素</span>
<span class="kd">let</span> <span class="nx">preWithoutLanguages</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">allPres</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.post-content pre</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">allPres</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">pre</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nx">pre</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">preWithoutLanguages</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">pre</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
<span class="c1">// 为这些&lt;pre&gt;元素外层添加一个.highlighter-rouge的div</span>
<span class="nx">preWithoutLanguages</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">pre</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 先看看它的&lt;code&gt;元素是否有language-开头的class</span>
  <span class="kd">let</span> <span class="nx">language</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span>
    <span class="nx">pre</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">classList</span>
  <span class="p">).</span><span class="nf">find</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">c</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">language-</span><span class="dl">"</span><span class="p">));</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">language</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">language</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">language-plaintext</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">div</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">highlighter-rouge</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">div</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="nx">language</span><span class="p">);</span>
  <span class="c1">// 内层还有一层div</span>
  <span class="kd">let</span> <span class="nx">innerDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">div</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">innerDiv</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">highlight</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">div</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">innerDiv</span><span class="p">);</span>
  <span class="nx">pre</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">insertBefore</span><span class="p">(</span><span class="nx">div</span><span class="p">,</span> <span class="nx">pre</span><span class="p">);</span>
  <span class="nx">innerDiv</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">pre</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="22-使用highlightjs">2.2 使用highlight.js</h3>
<p>直接使用<code class="language-plaintext highlighter-rouge">hljs.highlightAll()</code>会对所有的<code class="language-plaintext highlighter-rouge">&lt;pre&gt;&lt;code&gt;</code>标签进行高亮，使用如下 python 代码进行测试：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">hello world</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>
<p>高亮后的 html 结构如下图所示：
<img src="/post_assets/images/2023/10/16-highlight-structrue.png" alt="highlight.js高亮后的html结构" />
可以看到，其中的<code class="language-plaintext highlighter-rouge">code</code>标签中添加了类名<code class="language-plaintext highlighter-rouge">hljs</code>和<code class="language-plaintext highlighter-rouge">language-scss</code>，并添加了 <code class="language-plaintext highlighter-rouge">data-highlighted="yes"</code>属性。但是<code class="language-plaintext highlighter-rouge">python</code>被识别成了<code class="language-plaintext highlighter-rouge">scss</code>，这是由于一开始 jekyll 渲染代码块的时候没有将<code class="language-plaintext highlighter-rouge">language-xxx</code>类添加到<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签中，导致 highlight.js 无法识别指定的语言，所以进行了自动识别。因此在做这一步之前，需要先将<code class="language-plaintext highlighter-rouge">&lt;code&gt;</code>标签中的类名改为<code class="language-plaintext highlighter-rouge">language-xxx</code>，而这个语言类型就从<code class="language-plaintext highlighter-rouge">highlighter-rouge</code>元素中的<code class="language-plaintext highlighter-rouge">language-xxx</code>类名中获取。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">preContainers</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span>
  <span class="dl">"</span><span class="s2">.post-content div.highlighter-rouge</span><span class="dl">"</span>
<span class="p">);</span>
<span class="kd">let</span> <span class="nx">codeDataList</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">codeList</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">preContainers</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">preContainer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// 从自身的class列表中提取语言类别, language-开头的class</span>
  <span class="kd">let</span> <span class="nx">language</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="k">from</span><span class="p">(</span><span class="nx">preContainer</span><span class="p">.</span><span class="nx">classList</span><span class="p">).</span><span class="nf">find</span><span class="p">((</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nf">startsWith</span><span class="p">(</span><span class="dl">"</span><span class="s2">language-</span><span class="dl">"</span><span class="p">)</span>
  <span class="p">);</span>
  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">language</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">language</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">plaintext</span><span class="dl">"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">preContainer</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">code</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="s2">`language-</span><span class="p">${</span><span class="nx">language</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">language-</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// 代码高亮</span>
<span class="nx">hljs</span><span class="p">.</span><span class="nf">highlightAll</span><span class="p">();</span>
</code></pre></div></div>
<p>这样做之后，highlight.js 就能够正确识别代码块中的语言类型了。</p>

<h3 id="23-使用-web-worker-加载-highlightjs">2.3 使用 Web Worker 加载 highlight.js</h3>
<p>根据官方文档所说，当代码块很大时，为了避免页面卡顿，可以使用 Web Worker 加载 highlight.js。创建一个 worker.js 文件，然后将高亮的代码放在其中，注意这里需要我们将要高亮的代码文本传给 worker，然后 worker 返回高亮后的代码文本。不能直接使用 <code class="language-plaintext highlighter-rouge">hljs.highlightAll()</code>，否则会报错<code class="language-plaintext highlighter-rouge">Uncaught ReferenceError: document is not defined</code>。因为在 worker 中不能直接操作 DOM。</p>

<p>我这里是把所有的代码块放在一个数组中，然后传给 worker，worker 返回高亮后的代码数组，然后在主线程中将高亮后的代码替换原来的代码块。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// worker.js</span>
<span class="nx">onmessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nf">importScripts</span><span class="p">(</span><span class="dl">"</span><span class="s2">/assets/js/highlight/highlight.min.js</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">codeData</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">codeData</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>
    <span class="c1">// 如果语言类型不在 highlight.js 支持的语言列表中，则使用 plaintext</span>
    <span class="k">if </span><span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="nx">hljs</span><span class="p">.</span><span class="nf">getLanguage</span><span class="p">(</span><span class="nx">language</span><span class="p">)</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">language</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">plaintext</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">result</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span>
      <span class="nb">self</span><span class="p">.</span><span class="nx">hljs</span><span class="p">.</span><span class="nf">highlight</span><span class="p">(</span><span class="nx">codeData</span><span class="p">.</span><span class="nx">code</span><span class="p">,</span> <span class="p">{</span> <span class="na">language</span><span class="p">:</span> <span class="nx">language</span> <span class="p">}).</span><span class="nx">value</span>
    <span class="p">);</span>
  <span class="p">});</span>
  <span class="nf">postMessage</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>
<p>然后在主线程中使用 worker：</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 用上一步中的代码获取到的 preContainers</span>
<span class="nx">preContainers</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">preContainer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
  <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">preContainer</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">codeDataList</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span>
    <span class="na">language</span><span class="p">:</span> <span class="nx">language</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="dl">"</span><span class="s2">language-</span><span class="dl">"</span><span class="p">,</span> <span class="dl">""</span><span class="p">),</span>
    <span class="na">code</span><span class="p">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">textContent</span><span class="p">,</span>
  <span class="p">});</span>
  <span class="nx">codeList</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">worker</span><span class="p">.</span><span class="nx">onmessage</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
<span class="nx">codeList</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">code</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">code</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="p">});</span>
<span class="p">};</span>
<span class="nx">worker</span><span class="p">.</span><span class="nf">postMessage</span><span class="p">(</span><span class="nx">codeDataList</span><span class="p">);</span>
</code></pre></div></div>
<p>这样做之后，页面加载的时候就不会因为代码块太多而卡顿了。</p>

<h2 id="3-添加行号">3. 添加行号</h2>
<p>highlight.js 高亮后的代码是没有行号的，为了添加行号，我使用了一个叫<code class="language-plaintext highlighter-rouge">highlightjs-line-numbers.js</code>的插件。github 地址：<a href="https://github.com/wcoder/highlightjs-line-numbers.js">https://github.com/wcoder/highlightjs-line-numbers.js</a>。</p>
<h3 id="31-使用-highlightjs-line-numbersjs">3.1 使用 highlightjs-line-numbers.js</h3>
<p>下载或使用 CDN 引入<code class="language-plaintext highlighter-rouge">highlightjs-line-numbers.js</code>，然后在<code class="language-plaintext highlighter-rouge">hljs.highlightAll()</code>或其他高亮代码之后调用<code class="language-plaintext highlighter-rouge">hljs.initLineNumbersOnLoad()</code>即可。</p>
<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"/path/to/highlightjs-line-numbers.js"</span><span class="nt">&gt;&lt;/script&gt;</span>
<span class="nt">&lt;script&gt;</span><span class="nx">hljs</span><span class="p">.</span><span class="nf">initLineNumbersOnLoad</span><span class="p">();</span><span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>
<p>也可以使用参数配置，比如单行默认是不显示行号的，可以使用<code class="language-plaintext highlighter-rouge">hljs.initLineNumbersOnLoad({ singleLine: true })</code>来显示单行的行号。</p>

<p>添加了行号的 html 结构如下图所示：
<img src="/post_assets/images/2023/10/16-line-number-structrue.png" alt="highlight.js添加行号后的html结构" />
可以看到，它实现添加行号的方式是使用<code class="language-plaintext highlighter-rouge">table</code>来给代码最前面加上一列来显示行号。</p>

<p>注意，<code class="language-plaintext highlighter-rouge">hljs.initLineNumbersOnLoad()</code>并不是马上执行的，是一个异步操作，所以不能直接在它后面立刻执行其他依赖于行号的操作。</p>

<h3 id="32-样式优化">3.2 样式优化</h3>
<p>直接使用 highlightjs-line-numbers.js 生成的行号样式不太好看，我主要想修改的有以下几点：</p>
<ol>
  <li>调整基本样式，比如把左对齐改为右对齐，给行号右边加一道竖线等。</li>
  <li>支持后面的自动换行功能，多行文本的行号改为显示在这些文本的第一行而非中间。</li>
  <li>固定在左侧，不随着代码块的滚动而滚动。(sticky 定位)
    <div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.hljs</span> <span class="p">{</span>
 <span class="nl">background-color</span><span class="p">:</span> <span class="nb">transparent</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.hljs-ln</span> <span class="p">{</span>
 <span class="nl">padding-bottom</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.hljs-ln-numbers</span> <span class="p">{</span>
 <span class="nl">position</span><span class="p">:</span> <span class="n">sticky</span><span class="p">;</span>
 <span class="nl">position</span><span class="p">:</span> <span class="n">-webkit-sticky</span><span class="p">;</span> <span class="c">/* 兼容 Safari */</span>
 <span class="nl">left</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
 <span class="nl">background-color</span><span class="p">:</span> <span class="m">#F7F4F3</span><span class="p">;</span>
 <span class="nl">vertical-align</span><span class="p">:</span> <span class="nb">top</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.hljs-ln-code</span> <span class="p">{</span>
 <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">5px</span> <span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>
<span class="nc">.hljs-ln-n</span> <span class="p">{</span>
 <span class="nl">padding</span><span class="p">:</span> <span class="m">0</span> <span class="m">3px</span><span class="p">;</span>
 <span class="nl">margin-right</span><span class="p">:</span> <span class="m">3px</span><span class="p">;</span>
 <span class="nl">text-align</span><span class="p">:</span> <span class="nb">right</span><span class="p">;</span>
 <span class="nl">min-width</span><span class="p">:</span> <span class="m">2em</span><span class="p">;</span>
 <span class="nl">border-right</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="m">#e3e0dc</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>    </div>
    <p>注意调整一下背景色，避免 stikcy 定位滚动时显得不自然。</p>
  </li>
</ol>

<h2 id="4-其他功能">4. 其他功能</h2>
<h3 id="41-代码块头部添加快捷操作">4.1 代码块头部添加快捷操作</h3>
<p>我想在代码块的头部添加一些方便的操作，比如显示语言类型、复制代码、切换自动换行等。为了避免影响美观，只有鼠标悬停在代码块上时才显示这些操作。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// 放在之前 web worker 的 onmessage 事件中</span>
<span class="nx">codeList</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">code</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">code</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="c1">// ... other code</span>
  <span class="c1">// 显示语言类别</span>
  <span class="kd">let</span> <span class="nx">codeHeader</span> <span class="o">=</span>
    <span class="s2">`&lt;div class="code-header"&gt;`</span> <span class="o">+</span>
    <span class="s2">`&lt;span class="language"&gt;</span><span class="p">${</span><span class="nx">codeDataList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">language</span><span class="p">}</span><span class="s2">&lt;/span&gt; | `</span> <span class="o">+</span>
    <span class="s2">`&lt;span class="change-wrap-btn"&gt;&lt;i class="fa fa-rotate-right"&gt;&lt;/i&gt;自动换行&lt;/span&gt; | `</span> <span class="o">+</span>
    <span class="s2">`&lt;span class="copy-btn"&gt;&lt;i class="fa fa-copy"&gt;&lt;/i&gt;复制&lt;/span&gt;`</span> <span class="o">+</span>
    <span class="s2">`&lt;/div&gt;`</span><span class="p">;</span>
  <span class="c1">// 通过 insertAdjacentHTML 在代码块前面插入代码块头部</span>
  <span class="nx">code</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nf">insertAdjacentHTML</span><span class="p">(</span><span class="dl">"</span><span class="s2">afterbegin</span><span class="dl">"</span><span class="p">,</span> <span class="nx">codeHeader</span><span class="p">);</span>
<span class="p">});</span>
<span class="c1">// 默认隐藏顶部按钮，鼠标放在代码块上时显示</span>
<span class="nx">preContainers</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">preContainer</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">codeHeader</span> <span class="o">=</span> <span class="nx">preContainer</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">.code-header</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">codeHeader</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">);</span>
  <span class="nx">preContainer</span><span class="p">.</span><span class="nx">onmouseover</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">codeHeader</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">preContainer</span><span class="p">.</span><span class="nx">onmouseleave</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">codeHeader</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="dl">"</span><span class="s2">hidden</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.hidden</span> <span class="p">{</span>
  <span class="nl">display</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.code-header</span> <span class="p">{</span>
  <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
  <span class="nl">top</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="nl">right</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
  <span class="nl">z-index</span><span class="p">:</span> <span class="m">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="42-复制代码功能">4.2 复制代码功能</h3>
<p>首先获取需要复制的代码文本，由于添加了行号，不能直接使用<code class="language-plaintext highlighter-rouge">innerText</code>或<code class="language-plaintext highlighter-rouge">textContent</code>，一开始想的是在高亮之前获取过一次代码文本，可以直接用这个文本传入到复制函数中。但问题也很明显，临时存储文本的变量因为在复制函数中用到了，所以并不能及时释放，会占用一定的内存。所以还是直接获取高亮后的代码文本比较好。需要遍历每一行，把行号去掉，然后拼接成一个字符串。每一行的行号放在类名为<code class="language-plaintext highlighter-rouge">hljs-ln-numbers</code>的<code class="language-plaintext highlighter-rouge">&lt;td&gt;</code>标签中，每一行的代码放在类名为<code class="language-plaintext highlighter-rouge">hljs-ln-code</code>的<code class="language-plaintext highlighter-rouge">&lt;td&gt;</code>标签中。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.copy-btn</span><span class="dl">"</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">copyBtn</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">copyBtn</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">parent</span> <span class="o">=</span> <span class="nx">copyBtn</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">codeTable</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">.hljs-ln tbody</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">codeRows</span> <span class="o">=</span> <span class="nx">codeTable</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">tr</span><span class="dl">"</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">text</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="nx">codeRows</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">row</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// 忽略行号, 直接找.hljs-ln-code元素</span>
      <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">.hljs-ln-code</span><span class="dl">"</span><span class="p">);</span>
      <span class="nx">text</span> <span class="o">+=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">+</span> <span class="dl">"</span><span class="se">\n</span><span class="dl">"</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="nf">copyText</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>
<p>复制代码是通过创建一个<code class="language-plaintext highlighter-rouge">textarea</code>元素，然后把代码文本放进去，然后选中这个<code class="language-plaintext highlighter-rouge">textarea</code>元素，然后执行<code class="language-plaintext highlighter-rouge">document.execCommand("copy")</code>来实现的。当然如果浏览器支持<code class="language-plaintext highlighter-rouge">navigator.clipboard</code>，则使用<code class="language-plaintext highlighter-rouge">navigator.clipboard.writeText(text)</code>来实现。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">copyText</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if </span><span class="p">(</span><span class="nb">navigator</span><span class="p">.</span><span class="nx">clipboard</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// clipboard api 复制</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">clipboard</span><span class="p">.</span><span class="nf">writeText</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">textarea</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">"</span><span class="s2">textarea</span><span class="dl">"</span><span class="p">);</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">textarea</span><span class="p">);</span>
    <span class="c1">// 隐藏此输入框</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">fixed</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">clip</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">rect(0 0 0 0)</span><span class="dl">"</span><span class="p">;</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">10px</span><span class="dl">"</span><span class="p">;</span>
    <span class="c1">// 赋值</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">text</span><span class="p">;</span>
    <span class="c1">// 选中</span>
    <span class="nx">textarea</span><span class="p">.</span><span class="nf">select</span><span class="p">();</span>
    <span class="c1">// 复制</span>
    <span class="nb">document</span><span class="p">.</span><span class="nf">execCommand</span><span class="p">(</span><span class="dl">"</span><span class="s2">copy</span><span class="dl">"</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="c1">// 移除输入框</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nf">removeChild</span><span class="p">(</span><span class="nx">textarea</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h3 id="43-切换自动换行">4.3 切换自动换行</h3>
<p>由于代码块的宽度是固定的，所以当代码块中的代码过长时，会出现横向滚动条。虽然对于代码而言，大部分时候不自动换行显得更清晰，但有时候可能会有换行更方便的情况。因此我想添加一个切换自动换行的功能。</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">document</span><span class="p">.</span><span class="nf">querySelectorAll</span><span class="p">(</span><span class="dl">"</span><span class="s2">.change-wrap-btn</span><span class="dl">"</span><span class="p">).</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">changeWrapBtn</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">changeWrapBtn</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">pre</span> <span class="o">=</span> <span class="nx">changeWrapBtn</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">pre</span><span class="p">.</span><span class="nf">getElementsByTagName</span><span class="p">(</span><span class="dl">"</span><span class="s2">code</span><span class="dl">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">code</span><span class="p">.</span><span class="nx">classList</span><span class="p">.</span><span class="nf">toggle</span><span class="p">(</span><span class="dl">"</span><span class="s2">wrap</span><span class="dl">"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre></div></div>
<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">.post-content</span> <span class="nt">pre</span> <span class="nt">code</span><span class="nc">.wrap</span> <span class="p">{</span>
    <span class="nl">white-space</span><span class="p">:</span> <span class="n">pre-wrap</span> <span class="cp">!important</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="5-效果展示">5. 效果展示</h2>
<p>最终的效果如下图所示：
<img src="/post_assets/images/2023/10/16-highlight-final-display.gif" alt="效果展示" /></p>

<p>完整代码可以在我的 github 仓库中找到：<a href="https://github.com/lxmghct/lxmghct.github.io">https://github.com/lxmghct/lxmghct.github.io</a>。核心代码在<code class="language-plaintext highlighter-rouge">assets/js/highlight</code>和<code class="language-plaintext highlighter-rouge">assets/css/highlight</code>目录下。</p>


  </article>
</div>

<div class="prev-and-next">
  
  <div>
    <span>上一篇 ：</span><a href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/2023/11/05/java%E5%BF%BD%E7%95%A5%E5%BC%BA%E5%88%B6%E8%BD%AC%E6%8D%A2List%E7%AD%89%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%AD%A6%E5%91%8A.html" title="java忽略强制转换泛型类型的警告">java忽略强制转换泛型类型的警告</a>
  </div>
  
  
  <div>
    <span>下一篇 ：</span><a href="/%E5%BC%80%E5%8F%91%E6%97%A5%E5%BF%97/2023/10/15/jekyll%E6%B7%BB%E5%8A%A0beaudar%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F.html"
      title="jekyll添加beaudar评论系统">jekyll添加beaudar评论系统</a>
  </div>
  
  <div>
    <span> 版权所有，转载时必须以链接形式注明原始出处</span>
  </div>

</div>

<script>
    // 点击<a>跳转到/pages/tags.html#
    document.querySelectorAll(".index-post-tag a").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/tags.html#" + item.getAttribute("data-tag");
        });
    });
    document.querySelectorAll(".post-header a.category").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/classify.html#" + item.getAttribute("data-tag");
        });
    });

    // 生成目录
    // 获取文章内容的标题
    const headings = document.querySelectorAll(".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6");
    if (headings.length === 0) {
        document.querySelector(".toc-container").classList.add("hidden");
    } else {
        document.querySelector(".toc-container").classList.remove("hidden");
    }
    // 目录容器
    const tocList = document.getElementById("toc-list");
    const tempTocData = []

    // 遍历标题，生成目录
    headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1), 10); // 获取标题级别
        const listItem = document.createElement("li");
        const link = document.createElement("a");

        link.textContent = heading.textContent;
        if (!heading.id) {
            heading.id = heading.textContent.replace(/\s+/g, "-").toLowerCase();
        }
        link.href = `#${heading.id}`;
        listItem.appendChild(link);
        tocList.appendChild(listItem);
        tempTocData.push({
            level: level,
            dom: listItem
        })
    });

    // 设置目录项的左边距
    const minLevel = Math.min(...tempTocData.map(item => item.level))
    tempTocData.forEach(item => {
        let diff = item.level - minLevel
        item.dom.style.marginLeft = diff * 20 + "px"
        if (diff === 0) {
            item.dom.classList.add("root-toc")
        }
    })

</script>

<script type="text/javascript" src="/assets/js/highlight/highlight.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/highlightjs-line-numbers.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/run-highlight.js"></script>

<!-- beaudar评论, 日期+标题作为issue名 -->
<script src="https://beaudar.lipk.org/client.js"
  repo="lxmghct/blog-comments"
  branch="master"
  issue-term="【2023-10-15】 jekyll使用highlight.js对代码块进行高亮"
  theme="github-light"
  loading="false"
  crossorigin="anonymous" async>
</script></div>
          </div>
        


      </div>
    </div>
  </div>

  <div id="back-to-top">
    <a href="#"><i class="fa fa-arrow-circle-up"></i></a>
  </div>

  <footer class="site-footer">

  <div class="footer-col-wrapper">
    <div class="footer-col  footer-col-1">
      <ul class="contact-list">
        <li>lxmghct's blog</li>
        <li><a href="mailto:lxmghct@gmail.com">lxmghct@gmail.com</a></li>
        <li></li>
      </ul>
    </div>

    <div class="footer-col  footer-col-2">
      <div class="social-media-list">
        
        <a class="github" href="https://github.com/lxmghct" target="_blank" title="github"></a>
        
        
        <a class="rss" href="/feed.xml" target="_blank" title="rss"></a>
        
      </div>
    </div>

    <div class="footer-col  footer-col-3">
      <p class="text">学习、实践、分享<br> Learning, Practicing, Sharing</p>
    </div>
  </div>
  <div class="center sitedesc">
    Powered by <a href="http://jekyllrb.com/">Jekyll</a> | Hosted on <a href="https://pages.github.com/">
      Github</a>
  </div>

  <script type="text/javascript" src="/assets/js/jquery.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.js"></script>
  <script type="text/javascript" src="/assets/js/tagutils.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
  <script type="text/javascript" type="module" src="/assets/js/search.js"></script>

</footer>

</body>

</html>