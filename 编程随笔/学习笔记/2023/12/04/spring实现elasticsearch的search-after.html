<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>spring实现elasticsearch的search after | lxmghct's blog</title>
  <meta name="description"
    content="简单实现">


  <link rel="stylesheet" href=" /assets/css/bootstrap.css">
  <link rel="stylesheet" href=" /assets/css/font-awesome.css">
  <link rel="stylesheet" href=" /assets/css/main.css">
  <link rel="stylesheet" href=" /assets/css/layouts/default.css">
  <link rel="stylesheet" href=" /assets/css/highlight/default.min.css">
  <link rel="stylesheet" href=" /assets/css/includes/header.css">
  <link rel="stylesheet" href=" /assets/css/includes/footer.css">
  <link rel="stylesheet" href=" /assets/css/includes/search.css">
  <link rel="stylesheet" href=" /assets/css/includes/pagination.css">
  <link rel="stylesheet" href=" /assets/css/layouts/post.css">
  <link rel="stylesheet" href=" /assets/css/highlight/post-highlight.css">
  <link rel="stylesheet" href=" /assets/css/pages/index.css">
  <link rel="shortcut icon" href="" />
  <link rel="canonical" href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2023/12/04/spring%E5%AE%9E%E7%8E%B0elasticsearch%E7%9A%84search-after.html">
  <link rel="alternate" type="application/rss+xml" title="lxmghct's blog" href=" /feed.xml" />
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>
  <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</head>


<body>

  <div class="site-header">
	<div class="container">
		<div class="row">
			<div class="navbar navbar-default" role="navigation">

				<div class="navbar-header col-xs-8 col-sm-8 col-md-3 col-lg-3 center">
					<div class="header-title">
						<a href="/" title="首页"></a>
						<i class="fa fa-home fa-2x"></i>
						<a class="site-title" href="/">lxmghct's blog</a>
					</div>
				</div>

				<div class="col-md-6 col-lg-6 hidden-sm hidden-xs center">
					<div class="site-nav">
						<ul class="nav nav-pills">
							<li class="select"><a class="page-link" href="/pages/classify.html">分类</a></li>
							<li class="select"><a class="page-link" href="/pages/archive.html">归档</a></li>
							<li class="select"><a class="page-link" href="/pages/tags.html">标签</a></li>
							<li class="select"><a class="page-link" href="/pages/about.html">关于</a></li>
						</ul>
					</div>
				</div>

				<div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
					<div id="header-search" class="search-input-container">
						<input id="header-search-input" type="text" class="header-search-input" placeholder="Search">
						<!--搜索图标-->
						<i class="fa fa-search fa-lg search-icon"></i>
					</div>
				</div>

				<!-- 宽度不够时显示 -->
				<div class="hidden-lg hidden-md col-sm-4 col-xs-4">
					<div class="header-hidden-buttons">
						<i class="fa fa-search fa-lg search-icon"></i>
						<i class="fa fa-bars fa-2x menu-icon"></i>
						<!-- 用于控制菜单的显示和隐藏 -->
						<input type="checkbox" id="nav-trigger" class="nav-trigger">
					</div>
				</div>

				<div class="phone-nav">
					<ul>
						<li><a href="/">首 页</a></li>
						<li><a href="/pages/classify.html">分 类</a></li>
						<li><a href="/pages/archive.html">归 档</a></li>
						<li><a href="/pages/tags.html">标 签</a></li>
						<li><a href="/pages/about.html">关 于</a></li>
					</ul>
				</div>

			</div>
		</div>
	</div>
</div>

<!--遮罩层-->
<div class="search-mask"></div>
<div class="search-container">
  <!-- 右上角关闭按钮 -->
  <i class="fa fa-times fa-2x search-container-close"></i>
  <div class="search-container-main">
    <div class="search-container-wrapper">
      <div class="search-input-container">
        <input type="text" class="search-input" placeholder="Search">
        <!--搜索图标-->
        <i class="fa fa-search fa-lg search-icon search-start"></i>
        <!--关闭图标-->
        <i class="fa fa-times fa-lg search-icon search-clear"></i>
      </div>
      <div class="search-filter">
        <!--只查找标题选择框-->
        <input type="checkbox" class="search-filter-input">
        <span class="search-filter-text">只查找标题</span>
      </div>
      <div class="search-result-summary"></div>
      <div class="search-result-container">
      </div>
      <div class="search-pagination">
        <!-- pagination.html -->

<div class="my-pagination">
  <ul class="my-pager">
    <li class="active">1</li>
    <li>2</li>
  </ul>
  <span class="my-pagination__sizes">
    <span class="my-pagination__sizes__label">每页</span>
    <select class="my-pagination__sizes__select" autocomplete="off">
      <option>5</option>
      <option>10</option>
      <option>20</option>
    </select>
    <span class="my-pagination__sizes__label">条</span>
  </span>
  <span class="my-pagination__total">共 0 条</span>
  <span class="my-pagination__goto">
    <span class="my-pagination__goto__label">前往</span>
    <input class="my-pagination__goto__input" type="text" />
    <span class="my-pagination__goto__label">页</span>
  </span>
</div>

<script>
  (function () {
    const contentSelector = '.search-result-container';
    const parentSelector = '.search-pagination';
    const contentContainer = document.querySelector(`${contentSelector}`);
    if (!contentContainer || !contentSelector || !parentSelector) {
      console.error("pagination.html: content or parent is not defined");
      return;
    }
    const pageItems = []
    const pagerContainer = document.querySelector(`${parentSelector} .my-pager`);
    const totalContainer = document.querySelector(`${parentSelector} .my-pagination__total`);
    const sizesSelect = document.querySelector(`${parentSelector} .my-pagination__sizes__select`);
    const gotoInput = document.querySelector(`${parentSelector} .my-pagination__goto__input`);

    const paginationData = {
      total: 0,
      pageSize: 10,
      currentPage: 1
    }
    sizesSelect.value = paginationData.pageSize;

    function showPagerList() {
      const totalPage = Math.ceil(paginationData.total / paginationData.pageSize);
      pagerContainer.innerHTML = "";
      const createLi = (i) => {
        const li = document.createElement("li");
        li.innerText = i;
        pagerContainer.appendChild(li);
        // add click event
        if (i !== "...") {
          li.addEventListener("click", () => {
            paginationData.currentPage = i;
            changePage();
          });
        }
        // set active
        if (i === paginationData.currentPage) {
          li.classList.add("active");
        }
      }
      const start = 1, end = totalPage;
      const pagerNumberList = [];
      if (paginationData.currentPage - start > 3) {
        pagerNumberList.push(...[start, start + 1, "...", paginationData.currentPage - 1, paginationData.currentPage]);
      } else {
        for (let i = start; i <= paginationData.currentPage; i++) {
          pagerNumberList.push(i);
        }
      }
      if (end - paginationData.currentPage > 3) {
        pagerNumberList.push(...[paginationData.currentPage + 1, "...", end - 1, end]);
      } else {
        for (let i = paginationData.currentPage + 1; i <= end; i++) {
          pagerNumberList.push(i);
        }
      }
      pagerNumberList.forEach((item) => {
        createLi(item);
      });
    }

    function changeTotal() {
      pageItems.length = 0;
      for (let i = 0; i < contentContainer.children.length; i++) {
        if (contentContainer.children[i].classList.contains("my-pagination") || contentContainer.children[i].tagName === "SCRIPT") {
          continue;
        }
        pageItems.push(contentContainer.children[i]);
      }
      paginationData.total = pageItems.length;
      totalContainer.innerText = `共 ${paginationData.total} 条`;
    }

    function changeContentShow() {
      const showPageStart = paginationData.pageSize * (paginationData.currentPage - 1);
      const showPageEnd = paginationData.pageSize * paginationData.currentPage;
      for (let i = 0; i < paginationData.total; i++) {
        if (i >= showPageStart && i < showPageEnd) {
          pageItems[i].classList.remove("hide");
        } else {
          pageItems[i].classList.add("hide");
        }
      }
    }

    function changePage() {
      showPagerList();
      changeContentShow();
      gotoInput.value = paginationData.currentPage;
    }

    function startPagination() {
      changeTotal();
      changePage();
    }

    sizesSelect.addEventListener("change", (e) => {
      paginationData.pageSize = e.target.value;
      paginationData.currentPage = 1;
      changePage();
    });

    gotoInput.addEventListener("keyup", (e) => {
      if (e.keyCode === 13) {
        const gotoPage = parseInt(e.target.value);
        if (gotoPage > 0 && gotoPage <= Math.ceil(paginationData.total / paginationData.pageSize)) {
          paginationData.currentPage = gotoPage;
          changePage();
        }
      }
    });

    // 监听内容变化
    const observer = new MutationObserver((mutationsList) => {
      for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
          changeTotal();
          paginationData.currentPage = 1;
          changePage();
        }
      }
    });
    observer.observe(contentContainer, { childList: true });

    startPagination();
  })();
</script>
      </div>
    </div>
  </div>
</div>


  <div class="content">
    <div class="container">
      <div class="row main-container">

        
          <div class="col-md-2 col-lg-2 hidden-xs hidden-sm left-side fadein-left">
            
<div class="toc-container">
  <div class="toc-header">
    <h3>目录导航</h3>
  </div>
  <ul id="toc-list"></ul>
</div>

          </div>
          <div class="my-col col-xs-12 col-sm-12 col-md-8 col-lg-8 fadein-right">
            <div class="page-content box-shadow"><div class="post">

  <header class="post-header">
    <h1 class="post-title">spring实现elasticsearch的search after</h1>
    <div class="info">
      <p class="post-meta">
        <i class="fa fa-calendar"></i>
        &nbsp;
        2023-12-04 08:00
        
        
      </p>
      
      <span class="post-classify-list">
        <i class="fa fa-folder-open"></i>
        
        <a class="category" data-tag="编程随笔">编程随笔</a>
        
        <a class="category" data-tag="学习笔记">学习笔记</a>
        
      </span>
      &nbsp;
      
      
      <span class="post-tag-list">
        <i class="fa fa-tags"></i>
        <span class="index-post-tag">
          
          <a data-tag="elasticsearch">elasticsearch</a>
          
        </span>
      </span>
      
    </div>
  </header>

  <article class="post-content">
    <h2 id="简单实现">简单实现</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">org.elasticsearch.action.search.SearchRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.action.search.SearchResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RequestOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RestHighLevelClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.search.SearchHit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.search.builder.SearchSourceBuilder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>

    <span class="cm">/**
     * search after分页检索
     *
     * @param client              client
     * @param searchSourceBuilder searchSourceBuilder
     * @param pageNum             页码
     * @param pageSize            每页大小
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">SearchHit</span><span class="o">&gt;</span> <span class="nf">searchAfter</span><span class="o">(</span><span class="nc">RestHighLevelClient</span> <span class="n">client</span><span class="o">,</span> <span class="nc">SearchSourceBuilder</span> <span class="n">searchSourceBuilder</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageNum</span><span class="o">,</span> <span class="kt">int</span> <span class="n">pageSize</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">pageSize</span><span class="o">);</span>
        <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">trackTotalHits</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
        <span class="nc">SearchRequest</span> <span class="n">searchRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchRequest</span><span class="o">(</span><span class="s">"book"</span><span class="o">);</span>
        <span class="n">searchRequest</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">searchSourceBuilder</span><span class="o">);</span>
        <span class="nc">SearchHit</span><span class="o">[]</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// 跳过前面的数据</span>
        <span class="kt">int</span> <span class="n">totalCountOfSkip</span> <span class="o">=</span> <span class="o">(</span><span class="n">pageNum</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">*</span> <span class="n">pageSize</span><span class="o">;</span>
        <span class="c1">// 根据内存和性能的需求调整batchSize, 最大不超过10000</span>
        <span class="kt">int</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="n">totalCountOfSkip</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">totalCountOfSkip</span><span class="o">,</span> <span class="n">batchSize</span><span class="o">));</span>
            <span class="n">totalCountOfSkip</span> <span class="o">-=</span> <span class="n">batchSize</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="nc">SearchResponse</span> <span class="n">searchResponse</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
                <span class="n">searchHits</span> <span class="o">=</span> <span class="n">searchResponse</span><span class="o">.</span><span class="na">getHits</span><span class="o">().</span><span class="na">getHits</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">searchHits</span><span class="o">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="nc">SearchHit</span> <span class="n">lastHit</span> <span class="o">=</span> <span class="n">searchHits</span><span class="o">[</span><span class="n">searchHits</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">];</span>
            <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">searchAfter</span><span class="o">(</span><span class="n">lastHit</span><span class="o">.</span><span class="na">getSortValues</span><span class="o">());</span>
        <span class="o">}</span>
        <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">pageSize</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">SearchResponse</span> <span class="n">searchResponse</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
            <span class="n">searchHits</span> <span class="o">=</span> <span class="n">searchResponse</span><span class="o">.</span><span class="na">getHits</span><span class="o">().</span><span class="na">getHits</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">searchHits</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">searchHits</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>

</code></pre></div></div>

<h2 id="在项目中的实际使用">在项目中的实际使用</h2>

<p>我有一个需求是要查找某个 nested 字段的总匹配条目数，数据量较大会超过 10000 条，所以用 search after 来分页查询（这里用 scroll 可能更好一些）。数据的格式是这样的：</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"测试文本"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"keyword"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"test1"</span><span class="p">,</span><span class="w"> </span><span class="s2">"test2"</span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"text"</span><span class="p">:</span><span class="w"> </span><span class="s2">"测试文本2"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"keyword"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"test3"</span><span class="p">,</span><span class="w"> </span><span class="s2">"test4"</span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>需要查找所有<code class="language-plaintext highlighter-rouge">text.text</code>包含搜索关键字的条数和<code class="language-plaintext highlighter-rouge">text.keyword</code>包含搜索关键字的条数，这里用到了 script 来分别统计，并使用 search after来统计总数。</p>

<p>这里还有另外两个小的需求：</p>
<ol>
  <li>由于数据中的中文有简体和繁体，所以需要同时匹配简体和繁体，这里用到了<code class="language-plaintext highlighter-rouge">com.github.houbb.opencc4j.util.ZhConverterUtil</code>来转换简体和繁体。</li>
  <li>允许使用空格、加号、减号来分隔关键字，来表示与或非的关系，需要对搜索关键字中的这几个符号的格式做检查，并动态拼接 painless script。</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">com.mb.retrieval.utils</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.houbb.opencc4j.util.ZhConverterUtil</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.action.search.SearchRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.action.search.SearchResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RequestOptions</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.client.RestHighLevelClient</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.index.query.BoolQueryBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.script.Script</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.script.ScriptType</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.search.SearchHit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.search.builder.SearchSourceBuilder</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.elasticsearch.search.sort.SortOrder</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.HashMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Map</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>

    <span class="cm">/**
     * 获取匹配条数总数
     * @param directorySearchContent 目录标引搜索内容
     * @param textSearchContent 全文文本搜索内容
     * @param boolQueryBuilder boolQueryBuilder
     * @param client client
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getTotalCountOfMatchRecords</span><span class="o">(</span><span class="nc">String</span> <span class="n">directorySearchContent</span><span class="o">,</span> <span class="nc">String</span> <span class="n">textSearchContent</span><span class="o">,</span> <span class="nc">BoolQueryBuilder</span> <span class="n">boolQueryBuilder</span><span class="o">,</span> <span class="nc">RestHighLevelClient</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">directoryPainlessScript</span> <span class="o">=</span> <span class="n">getPainlessScriptOfMatchCountSearch</span><span class="o">(</span><span class="n">directorySearchContent</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">textPainlessScript</span> <span class="o">=</span> <span class="n">getPainlessScriptOfMatchCountSearch</span><span class="o">(</span><span class="n">textSearchContent</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">directoryPainlessScript</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">textPainlessScript</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">SearchRequest</span> <span class="n">searchRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchRequest</span><span class="o">(</span><span class="s">"book"</span><span class="o">);</span>
        <span class="nc">SearchSourceBuilder</span> <span class="n">searchSourceBuilder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SearchSourceBuilder</span><span class="o">();</span>
        <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="n">boolQueryBuilder</span><span class="o">).</span><span class="na">fetchSource</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="na">sort</span><span class="o">(</span><span class="s">"id"</span><span class="o">,</span> <span class="nc">SortOrder</span><span class="o">.</span><span class="na">ASC</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">textPainlessScript</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Script</span> <span class="n">script1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Script</span><span class="o">(</span><span class="nc">ScriptType</span><span class="o">.</span><span class="na">INLINE</span><span class="o">,</span> <span class="s">"painless"</span><span class="o">,</span>
                    <span class="s">"params['_source']['text'].stream().filter(t -&gt; {String w = t.get(\"text\");return "</span> <span class="o">+</span> <span class="n">textPainlessScript</span> <span class="o">+</span> <span class="s">";}).count()"</span><span class="o">,</span>
                    <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;());</span>
            <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">scriptField</span><span class="o">(</span><span class="s">"text_text"</span><span class="o">,</span> <span class="n">script1</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">directoryPainlessScript</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Script</span> <span class="n">script2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Script</span><span class="o">(</span><span class="nc">ScriptType</span><span class="o">.</span><span class="na">INLINE</span><span class="o">,</span> <span class="s">"painless"</span><span class="o">,</span>
                    <span class="s">"params['_source']['text'].stream().filter(t -&gt; t.get(\"keyword\").stream().anyMatch(w -&gt; "</span> <span class="o">+</span> <span class="n">directoryPainlessScript</span> <span class="o">+</span> <span class="s">")).count()"</span><span class="o">,</span>
                    <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;());</span>
            <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">scriptField</span><span class="o">(</span><span class="s">"text_keyword"</span><span class="o">,</span> <span class="n">script2</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kt">int</span> <span class="n">batchSize</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>
        <span class="n">searchSourceBuilder</span><span class="o">.</span><span class="na">size</span><span class="o">(</span><span class="n">batchSize</span><span class="o">);</span>
        <span class="n">searchRequest</span><span class="o">.</span><span class="na">source</span><span class="o">(</span><span class="n">searchSourceBuilder</span><span class="o">);</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">SearchResponse</span> <span class="n">searchResponse</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">search</span><span class="o">(</span><span class="n">searchRequest</span><span class="o">,</span> <span class="nc">RequestOptions</span><span class="o">.</span><span class="na">DEFAULT</span><span class="o">);</span>
                <span class="nc">SearchHit</span><span class="o">[]</span> <span class="n">searchHits</span> <span class="o">=</span> <span class="n">searchResponse</span><span class="o">.</span><span class="na">getHits</span><span class="o">().</span><span class="na">getHits</span><span class="o">();</span>
                <span class="k">for</span> <span class="o">(</span><span class="nc">SearchHit</span> <span class="n">hit</span> <span class="o">:</span> <span class="n">searchHits</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">textPainlessScript</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">hit</span><span class="o">.</span><span class="na">getFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"text_text"</span><span class="o">).</span><span class="na">getValue</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">directoryPainlessScript</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">hit</span><span class="o">.</span><span class="na">getFields</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"text_keyword"</span><span class="o">).</span><span class="na">getValue</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">searchHits</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="n">batchSize</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">searchRequest</span><span class="o">.</span><span class="na">source</span><span class="o">().</span><span class="na">searchAfter</span><span class="o">(</span><span class="n">searchHits</span><span class="o">[</span><span class="n">searchHits</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">].</span><span class="na">getSortValues</span><span class="o">());</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">total</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getPainlessScriptOfMatchCountSearch</span><span class="o">(</span><span class="nc">String</span> <span class="n">searchContent</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">searchContent</span> <span class="o">=</span> <span class="n">removeEmptyChar</span><span class="o">(</span><span class="n">searchContent</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">searchContent</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">null</span><span class="o">;</span> <span class="o">}</span>
        <span class="nc">StringBuilder</span> <span class="n">painlessScript</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">StringBuilder</span> <span class="n">word</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">Character</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">delimiterMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">Character</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;()</span> <span class="o">{{</span>
            <span class="n">put</span><span class="o">(</span><span class="sc">' '</span><span class="o">,</span> <span class="s">"||"</span><span class="o">);</span> <span class="n">put</span><span class="o">(</span><span class="sc">'+'</span><span class="o">,</span> <span class="s">"&amp;&amp;"</span><span class="o">);</span> <span class="n">put</span><span class="o">(</span><span class="sc">'-'</span><span class="o">,</span> <span class="s">"&amp;&amp; !"</span><span class="o">);</span>
        <span class="o">}};</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">char</span> <span class="n">c</span> <span class="o">:</span> <span class="n">searchContent</span><span class="o">.</span><span class="na">toCharArray</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">delimiterMap</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">painlessScript</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">getSimpleAndTraditionalPainlessScriptOfWord</span><span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
                <span class="o">}</span>
                <span class="n">painlessScript</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">delimiterMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">c</span><span class="o">));</span>
                <span class="n">word</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">StringBuilder</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">word</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">painlessScript</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">getSimpleAndTraditionalPainlessScriptOfWord</span><span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">toString</span><span class="o">()));</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">painlessScript</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">startsWith</span><span class="o">(</span><span class="s">"&amp;&amp; "</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">painlessScript</span><span class="o">.</span><span class="na">delete</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">painlessScript</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">getSimpleAndTraditionalPainlessScriptOfWord</span><span class="o">(</span><span class="nc">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">word</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">word</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nc">String</span> <span class="n">simplifiedWord</span> <span class="o">=</span> <span class="nc">ZhConverterUtil</span><span class="o">.</span><span class="na">convertToSimple</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="nc">String</span> <span class="n">traditionalWord</span> <span class="o">=</span> <span class="nc">ZhConverterUtil</span><span class="o">.</span><span class="na">convertToTraditional</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">simplifiedWord</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">traditionalWord</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"w.contains(\""</span> <span class="o">+</span> <span class="n">simplifiedWord</span> <span class="o">+</span> <span class="s">"\")"</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"(w.contains(\""</span> <span class="o">+</span> <span class="n">simplifiedWord</span> <span class="o">+</span> <span class="s">"\") || w.contains(\""</span> <span class="o">+</span> <span class="n">traditionalWord</span> <span class="o">+</span> <span class="s">"\"))"</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">String</span> <span class="nf">removeEmptyChar</span><span class="o">(</span><span class="nc">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">""</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 多个空格、加号、减号只保留一个</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s+"</span><span class="o">,</span> <span class="s">" "</span><span class="o">)</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\++"</span><span class="o">,</span> <span class="s">"+"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"-+"</span><span class="o">,</span> <span class="s">"-"</span><span class="o">)</span>
                <span class="c1">// 去除加号和减号前后的空格</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s*\\+\\s*"</span><span class="o">,</span> <span class="s">"+"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s*-\\s*"</span><span class="o">,</span> <span class="s">"-"</span><span class="o">)</span>
                <span class="c1">// 加号和减号相邻时，如果末尾是减号则只保留一个减号，否则只保留一个加号</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"([+-])+-"</span><span class="o">,</span> <span class="s">"-"</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"([+-])+"</span><span class="o">,</span> <span class="s">"+"</span><span class="o">)</span>
                <span class="c1">// 去除开头的加号和空格，去除结尾的加号和减号和空格</span>
                <span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"^\\s*\\+\\s*"</span><span class="o">,</span> <span class="s">""</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">"\\s*[+-]*\\s*$"</span><span class="o">,</span> <span class="s">""</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">str</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>


  </article>
</div>

<div class="prev-and-next">
  
  <div>
    <span>上一篇 ：</span><a href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/2023/12/19/%E8%A1%A8%E5%8D%95%E4%B8%AD%E7%9A%84button%E7%82%B9%E5%87%BB%E5%90%8E%E8%87%AA%E5%8A%A8%E5%88%B7%E6%96%B0%E9%A1%B5%E9%9D%A2%E9%97%AE%E9%A2%98.html" title="表单中的button点击后自动刷新页面问题">表单中的button点击后自动刷新页面问题</a>
  </div>
  
  
  <div>
    <span>下一篇 ：</span><a href="/%E7%BC%96%E7%A8%8B%E9%9A%8F%E7%AC%94/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/2023/12/04/elasticsearch%E4%BD%BF%E7%94%A8script%E6%9F%A5%E8%AF%A2%E5%92%8C%E6%8E%92%E5%BA%8F.html"
      title="elasticsearch使用script查询和排序">elasticsearch使用script查询和排序</a>
  </div>
  
  <div>
    <span> 版权所有，转载时必须以链接形式注明原始出处</span>
  </div>

</div>

<script>
    // 点击<a>跳转到/pages/tags.html#
    document.querySelectorAll(".index-post-tag a").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/tags.html#" + item.getAttribute("data-tag");
        });
    });
    document.querySelectorAll(".post-header a.category").forEach((item) => {
        item.addEventListener("click", () => {
            window.location.href = "/pages/classify.html#" + item.getAttribute("data-tag");
        });
    });

    // 生成目录
    // 获取文章内容的标题
    const headings = document.querySelectorAll(".post-content h1, .post-content h2, .post-content h3, .post-content h4, .post-content h5, .post-content h6");
    if (headings.length === 0) {
        document.querySelector(".toc-container").classList.add("hidden");
    } else {
        document.querySelector(".toc-container").classList.remove("hidden");
    }
    // 目录容器
    const tocList = document.getElementById("toc-list");
    const tempTocData = []

    // 遍历标题，生成目录
    headings.forEach((heading) => {
        const level = parseInt(heading.tagName.charAt(1), 10); // 获取标题级别
        const listItem = document.createElement("li");
        const link = document.createElement("a");

        link.textContent = heading.textContent;
        if (!heading.id) {
            heading.id = heading.textContent.replace(/\s+/g, "-").toLowerCase();
        }
        link.href = `#${heading.id}`;
        listItem.appendChild(link);
        tocList.appendChild(listItem);
        tempTocData.push({
            level: level,
            dom: listItem
        })
    });

    // 设置目录项的左边距
    const minLevel = Math.min(...tempTocData.map(item => item.level))
    tempTocData.forEach(item => {
        let diff = item.level - minLevel
        item.dom.style.marginLeft = diff * 20 + "px"
        if (diff === 0) {
            item.dom.classList.add("root-toc")
        }
    })

</script>

<script type="text/javascript" src="/assets/js/highlight/highlight.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/highlightjs-line-numbers.min.js"></script>
<script type="text/javascript" src="/assets/js/highlight/run-highlight.js"></script>

<!-- beaudar评论, 日期+标题作为issue名 -->
<script src="https://beaudar.lipk.org/client.js"
  repo="lxmghct/blog-comments"
  branch="master"
  issue-term="【2023-12-04】 spring实现elasticsearch的search after"
  theme="github-light"
  loading="false"
  crossorigin="anonymous" async>
</script></div>
          </div>
        


      </div>
    </div>
  </div>

  <div id="back-to-top">
    <a href="#"><i class="fa fa-arrow-circle-up"></i></a>
  </div>

  <footer class="site-footer">

  <div class="footer-col-wrapper">
    <div class="footer-col  footer-col-1">
      <ul class="contact-list">
        <li>lxmghct's blog</li>
        <li><a href="mailto:lxmghct@gmail.com">lxmghct@gmail.com</a></li>
        <li></li>
      </ul>
    </div>

    <div class="footer-col  footer-col-2">
      <div class="social-media-list">
        
        <a class="github" href="https://github.com/lxmghct" target="_blank" title="github"></a>
        
        
        <a class="rss" href="/feed.xml" target="_blank" title="rss"></a>
        
      </div>
    </div>

    <div class="footer-col  footer-col-3">
      <p class="text">学习、实践、分享<br> Learning, Practicing, Sharing</p>
    </div>
  </div>
  <div class="center sitedesc">
    Powered by <a href="http://jekyllrb.com/">Jekyll</a> | Hosted on <a href="https://pages.github.com/">
      Github</a>
  </div>

  <script type="text/javascript" src="/assets/js/jquery.js"></script>
  <script type="text/javascript" src="/assets/js/bootstrap.js"></script>
  <script type="text/javascript" src="/assets/js/tagutils.js"></script>
  <script type="text/javascript" src="/assets/js/main.js"></script>
  <script type="text/javascript" type="module" src="/assets/js/search.js"></script>

</footer>

</body>

</html>